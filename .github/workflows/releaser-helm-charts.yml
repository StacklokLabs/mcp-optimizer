name: Publish Helm Charts
on:
  workflow_call:
  workflow_dispatch:
    inputs:
      version:
        description: 'Chart version to release (e.g., 0.0.2)'
        required: false
        type: string

jobs:
  release-helm-charts:
    name: Release Helm Charts
    runs-on: ubuntu-latest

    permissions:
      contents: write
      packages: write
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"

      - name: Update Chart Version from Tag or Input
        if: startsWith(github.ref, 'refs/tags/v') || inputs.version != ''
        run: |
          # Use manual input version if provided, otherwise extract from tag
          if [ -n "${{ inputs.version }}" ]; then
            VERSION="${{ inputs.version }}"
            echo "Using manually specified version: $VERSION"
          else
            # Extract version from tag (e.g., v0.0.2 -> 0.0.2)
            VERSION=${GITHUB_REF#refs/tags/v}
            echo "Using version from tag: $VERSION"
          fi
          
          # Update version and appVersion in Chart.yaml
          sed -i "s/^version:.*/version: $VERSION/" helm/mcp-optimizer/Chart.yaml
          sed -i "s/^appVersion:.*/appVersion: \"$VERSION\"/" helm/mcp-optimizer/Chart.yaml
          
          # Show the changes
          echo "Updated Chart.yaml:"
          cat helm/mcp-optimizer/Chart.yaml

      - name: Run chart-releaser
        uses: helm/chart-releaser-action@cae68fefc6b5f367a0275617c9f83181ba54714f # v1.7.0
        with:
          config: cr.yaml
          charts_dir: helm
          mark_as_latest: false
          skip_existing: true
        env:
          CR_TOKEN: "${{ secrets.GITHUB_TOKEN }}"

      - name: Login to GitHub Container Registry
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3.7.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Cosign
        uses: sigstore/cosign-installer@faadad0cce49287aee09b3a48701e75088a2c6ad # v4.0.0

      - name: Publish and Sign OCI Charts
        run: |
          # Check if chart packages directory exists and contains files
          if [ ! -d .cr-release-packages ]; then
            echo "No charts were released (no .cr-release-packages directory found)"
            exit 0
          fi
          
          chart_count=$(find .cr-release-packages -name '*.tgz' -type f | wc -l)
          if [ "$chart_count" -eq 0 ]; then
            echo "No charts were released (no .tgz files found)"
            exit 0
          fi
          
          echo "Publishing and signing $chart_count chart(s)..."
          
          # Lowercase repository name for OCI registry (required)
          REPO_LOWER=$(echo "${GITHUB_REPOSITORY}" | tr '[:upper:]' '[:lower:]')
          
          # Use modern command substitution and handle filenames safely
          find .cr-release-packages -name '*.tgz' -type f -print0 | while IFS= read -r -d '' chart; do
            echo "Processing chart: $chart"
            
            # Push chart and capture output
            helm push "$chart" oci://ghcr.io/${REPO_LOWER} |& tee helm-push-output.log
            
            # Extract chart name and digest
            file_name="${chart##*/}"
            chart_name="${file_name%-*}"
            digest=$(awk -F "[, ]+" '/Digest/{print $NF}' < helm-push-output.log)
            
            if [ -z "$digest" ]; then
              echo "Error: Could not extract digest for $chart"
              exit 1
            fi
            
            # Sign the chart
            echo "Signing chart: ghcr.io/${REPO_LOWER}/${chart_name}@${digest}"
            cosign sign -y "ghcr.io/${REPO_LOWER}/${chart_name}@${digest}"
          done
        env:
          COSIGN_EXPERIMENTAL: 1

