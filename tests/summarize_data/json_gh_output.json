[{"assignees":[],"author":{"id":"MDQ6VXNlcjE0NTU2NA==","is_bot":false,"login":"JAORMX","name":"Juan Antonio Osorio"},"body":"## Overview\n\nImplement Kubernetes CRD and controller support for webhook middleware configuration. This enables declarative webhook configuration for MCP servers running in Kubernetes clusters.\n\n**RFC**: https://github.com/stacklok/toolhive-rfcs/blob/main/rfcs/THV-0017-dynamic-webhook-middleware.md\n\n**Depends on**: Phase 2 (Validating webhook), Phase 3 (Mutating webhook)\n\n## Files to Create\n\n| File | Purpose |\n|------|---------|\n| `cmd/thv-operator/api/v1alpha1/mcpwebhookconfig_types.go` | CRD type definitions |\n| `cmd/thv-operator/controllers/mcpwebhookconfig_controller.go` | Controller implementation |\n| `cmd/thv-operator/pkg/controllerutil/webhook.go` | Webhook config resolution helpers |\n| `config/crd/bases/toolhive.stacklok.dev_mcpwebhookconfigs.yaml` | CRD manifest (generated) |\n\n## Files to Modify\n\n| File | Changes |\n|------|---------|\n| `cmd/thv-operator/api/v1alpha1/mcpserver_types.go` | Add `WebhookConfigRef` field |\n| `cmd/thv-operator/controllers/mcpserver_controller.go` | Handle webhook config resolution, add watcher |\n| `cmd/thv-operator/controllers/mcpserver_runconfig.go` | Add webhook config to RunConfig builder |\n\n## CRD Definition\n\n```go\n// cmd/thv-operator/api/v1alpha1/mcpwebhookconfig_types.go\n\ntype MCPWebhookConfigSpec struct {\n    // Validating webhooks called to approve/deny requests\n    Validating []WebhookSpec `json:\"validating,omitempty\"`\n    \n    // Mutating webhooks called to transform requests\n    Mutating []WebhookSpec `json:\"mutating,omitempty\"`\n}\n\ntype WebhookSpec struct {\n    // Name is a unique identifier for this webhook\n    Name string `json:\"name\"`\n    \n    // URL is the webhook endpoint (must be HTTPS)\n    URL string `json:\"url\"`\n    \n    // Timeout for webhook calls (default: 10s, max: 30s)\n    // +optional\n    Timeout *metav1.Duration `json:\"timeout,omitempty\"`\n    \n    // FailurePolicy defines behavior on webhook errors\n    // +kubebuilder:validation:Enum=Fail;Ignore\n    // +kubebuilder:default=Fail\n    FailurePolicy FailurePolicy `json:\"failurePolicy,omitempty\"`\n    \n    // TLSConfig for webhook connection\n    // +optional\n    TLSConfig *WebhookTLSConfig `json:\"tlsConfig,omitempty\"`\n    \n    // HMACSecretRef references a secret containing HMAC signing key\n    // +optional\n    HMACSecretRef *SecretKeyRef `json:\"hmacSecretRef,omitempty\"`\n}\n\ntype WebhookTLSConfig struct {\n    // CASecretRef references a secret containing CA certificate\n    // +optional\n    CASecretRef *SecretKeyRef `json:\"caSecretRef,omitempty\"`\n    \n    // ClientCertSecretRef references a secret containing client cert for mTLS\n    // +optional\n    ClientCertSecretRef *SecretKeyRef `json:\"clientCertSecretRef,omitempty\"`\n    \n    // InsecureSkipVerify disables certificate verification (NOT for production)\n    // +optional\n    InsecureSkipVerify bool `json:\"insecureSkipVerify,omitempty\"`\n}\n\ntype SecretKeyRef struct {\n    // Name of the secret\n    Name string `json:\"name\"`\n    // Key within the secret\n    Key string `json:\"key\"`\n}\n\ntype MCPWebhookConfigStatus struct {\n    // ConfigHash is a hash of the spec for change detection\n    ConfigHash string `json:\"configHash,omitempty\"`\n    \n    // ReferencingServers lists MCPServers using this config\n    ReferencingServers []string `json:\"referencingServers,omitempty\"`\n    \n    // ObservedGeneration is the last observed generation\n    ObservedGeneration int64 `json:\"observedGeneration,omitempty\"`\n    \n    // Conditions represent the latest available observations\n    Conditions []metav1.Condition `json:\"conditions,omitempty\"`\n}\n```\n\n## Example CRD Instance\n\n```yaml\napiVersion: toolhive.stacklok.dev/v1alpha1\nkind: MCPWebhookConfig\nmetadata:\n  name: company-webhooks\n  namespace: mcp-servers\nspec:\n  validating:\n    - name: policy-check\n      url: https://policy.company.com/validate\n      timeout: 5s\n      failurePolicy: Fail\n      tlsConfig:\n        caSecretRef:\n          name: webhook-ca\n          key: ca.crt\n      hmacSecretRef:\n        name: webhook-secrets\n        key: policy-hmac\n\n  mutating:\n    - name: request-enricher\n      url: https://enricher.company.com/mutate\n      timeout: 3s\n      failurePolicy: Ignore\n```\n\n## MCPServer Reference\n\n```yaml\napiVersion: toolhive.stacklok.dev/v1alpha1\nkind: MCPServer\nmetadata:\n  name: my-mcp-server\nspec:\n  # ... other fields ...\n  webhookConfigRef:\n    name: company-webhooks\n```\n\n```go\n// In mcpserver_types.go\ntype MCPServerSpec struct {\n    // ... existing fields ...\n    \n    // WebhookConfigRef references an MCPWebhookConfig for webhook middleware\n    // +optional\n    WebhookConfigRef *WebhookConfigRef `json:\"webhookConfigRef,omitempty\"`\n}\n\ntype WebhookConfigRef struct {\n    // Name of the MCPWebhookConfig resource\n    Name string `json:\"name\"`\n}\n```\n\n## Controller Implementation\n\nFollow the pattern from `MCPExternalAuthConfig`:\n\n1. **Finalizer**: Prevent deletion while referenced by MCPServers\n2. **Hash calculation**: Detect config changes\n3. **Status updates**: Track referencing servers\n4. **MCPServer reconciliation trigger**: On config changes\n\n```go\n// cmd/thv-operator/controllers/mcpwebhookconfig_controller.go\n\nconst webhookConfigFinalizer = \"toolhive.stacklok.dev/webhookconfig-finalizer\"\n\nfunc (r *MCPWebhookConfigReconciler) Reconcile(ctx context.Context, req ctrl.Request) (ctrl.Result, error) {\n    // 1. Fetch MCPWebhookConfig\n    // 2. Handle deletion (finalizer logic)\n    // 3. Calculate config hash\n    // 4. Update status if changed\n    // 5. Find referencing MCPServers\n    // 6. Trigger reconciliation for affected MCPServers\n}\n```\n\n## Watch Setup\n\n```go\n// In mcpserver_controller.go SetupWithManager\nwebhookConfigHandler := handler.EnqueueRequestsFromMapFunc(\n    func(ctx context.Context, obj client.Object) []reconcile.Request {\n        // Find MCPServers that reference this MCPWebhookConfig\n        // Return reconcile requests for each\n    },\n)\n\nreturn ctrl.NewControllerManagedBy(mgr).\n    For(&mcpv1alpha1.MCPServer{}).\n    Watches(&mcpv1alpha1.MCPWebhookConfig{}, webhookConfigHandler).\n    Complete(r)\n```\n\n## Config Resolution\n\n```go\n// cmd/thv-operator/pkg/controllerutil/webhook.go\n\nfunc AddWebhookConfigOptions(\n    ctx context.Context,\n    c client.Client,\n    namespace string,\n    webhookConfigRef *mcpv1alpha1.WebhookConfigRef,\n    options *[]runner.RunConfigBuilderOption,\n) error {\n    // 1. Fetch MCPWebhookConfig\n    // 2. Resolve secret references (HMAC, TLS certs)\n    // 3. Convert to runner.WebhookConfig\n    // 4. Add to options\n}\n```\n\n## Tests\n\n- Controller unit tests with fake client\n- Integration tests with envtest\n- E2E tests with Chainsaw:\n  - Create MCPWebhookConfig\n  - Create MCPServer referencing it\n  - Verify webhook config applied\n  - Update MCPWebhookConfig, verify reconciliation\n  - Delete MCPWebhookConfig (should fail while referenced)\n\n## Acceptance Criteria\n\n- [ ] CRD defined and generated (`make manifests`)\n- [ ] Controller implements reconciliation loop\n- [ ] Hash-based change detection working\n- [ ] Finalizer prevents deletion while referenced\n- [ ] MCPServer reconciliation triggered on config changes\n- [ ] Secret references resolved correctly\n- [ ] Unit tests with >80% coverage\n- [ ] Integration tests with envtest\n- [ ] E2E tests with Chainsaw\n- [ ] Code passes `task lint` and `task test`\n","closed":false,"closedAt":null,"closedByPullRequestsReferences":[],"comments":[],"createdAt":"2026-01-22T06:40:50Z","id":"I_kwDOOHdoXs7k-Hlt","isPinned":false,"labels":[{"id":"LA_kwDOOHdoXs8AAAAB7bU01g","name":"enhancement","description":"New feature or request","color":"a2eeef"},{"id":"LA_kwDOOHdoXs8AAAAB828HLQ","name":"go","description":"Pull requests that update go code","color":"16e2e2"},{"id":"LA_kwDOOHdoXs8AAAAB9PXLvA","name":"kubernetes","description":"Items related to Kubernetes","color":"0000FF"},{"id":"LA_kwDOOHdoXs8AAAACJiu1Bw","name":"api","description":"Items related to the API","color":"b404c2"},{"id":"LA_kwDOOHdoXs8AAAACNqqAVQ","name":"operator","description":"","color":"ededed"}],"milestone":null,"number":3401,"reactionGroups":[],"state":"OPEN","stateReason":"","title":"Webhook Middleware Phase 5: Kubernetes CRD and controller integration","updatedAt":"2026-01-22T06:41:52Z","url":"https://github.com/stacklok/toolhive/issues/3401"},{"assignees":[],"author":{"id":"MDQ6VXNlcjE0NTU2NA==","is_bot":false,"login":"JAORMX","name":"Juan Antonio Osorio"},"body":"## Overview\n\nAdd CLI support for configuring webhook middleware via command-line flags and configuration files. This enables users to easily configure validating and mutating webhooks when running MCP servers with `thv run`.\n\n**RFC**: https://github.com/stacklok/toolhive-rfcs/blob/main/rfcs/THV-0017-dynamic-webhook-middleware.md\n\n**Depends on**: Phase 2 (Validating webhook), Phase 3 (Mutating webhook)\n\n## Files to Create\n\n| File | Purpose |\n|------|---------|\n| `pkg/webhook/config.go` | YAML/JSON config file parsing and validation |\n\n## Files to Modify\n\n| File | Changes |\n|------|---------|\n| `cmd/thv/app/run_flags.go` | Add `--webhook-config` flag to `RunFlags` struct |\n| `cmd/thv/app/run.go` | Parse webhook config and populate RunConfig |\n\n## CLI Usage\n\n```bash\n# Single webhook config file\nthv run postgres-mcp --webhook-config webhooks.yaml\n\n# Multiple webhook config files (combined)\nthv run postgres-mcp \\\n  --webhook-config policy-webhook.yaml \\\n  --webhook-config enricher-webhook.yaml\n```\n\n## Configuration File Format\n\n```yaml\n# webhooks.yaml\nvalidating:\n  - name: policy-check\n    url: https://policy.example.com/validate\n    timeout: 5s\n    failure_policy: fail\n    tls_config:\n      ca_bundle: /path/to/ca.crt\n      # skip_verify: false  # for development only\n    hmac_secret_ref: webhook-secret,target=WEBHOOK_HMAC\n\n  - name: rate-limiter\n    url: https://ratelimit.example.com/check\n    timeout: 2s\n    failure_policy: ignore\n\nmutating:\n  - name: hr-enrichment\n    url: https://hr-api.example.com/enrich\n    timeout: 3s\n    failure_policy: ignore\n\n  - name: cmdb-enrichment\n    url: https://cmdb-api.example.com/enrich\n    timeout: 3s\n    failure_policy: ignore\n    tls_config:\n      client_cert: /path/to/cert.pem\n      client_key: /path/to/key.pem\n```\n\n## Config Parsing Implementation\n\n```go\n// pkg/webhook/config.go\n\ntype FileConfig struct {\n    Validating []WebhookConfig `yaml:\"validating\" json:\"validating\"`\n    Mutating   []WebhookConfig `yaml:\"mutating\" json:\"mutating\"`\n}\n\nfunc LoadConfig(path string) (*FileConfig, error)\nfunc MergeConfigs(configs ...*FileConfig) *FileConfig\nfunc ValidateConfig(config *FileConfig) error\n```\n\n## Flag Integration\n\n```go\n// cmd/thv/app/run_flags.go\ntype RunFlags struct {\n    // ... existing flags ...\n    \n    // WebhookConfigs is a list of paths to webhook configuration files\n    WebhookConfigs []string\n}\n\n// In flag registration\ncmd.Flags().StringArrayVar(&flags.WebhookConfigs, \"webhook-config\", nil,\n    \"Path to webhook configuration file (can be specified multiple times)\")\n```\n\n## RunConfig Population\n\nIn `cmd/thv/app/run.go`, after parsing flags:\n\n1. Load each webhook config file\n2. Merge configs (later files take precedence for same-named webhooks)\n3. Validate merged config\n4. Populate `RunConfig.ValidatingWebhooks` and `RunConfig.MutatingWebhooks`\n\n## Validation Rules\n\n- URL must be valid HTTPS URL (HTTP only allowed with explicit flag for dev)\n- Timeout must be between 1s and 30s\n- Failure policy must be \"fail\" or \"ignore\"\n- TLS config paths must exist if specified\n- HMAC secret ref must be valid secret reference format\n\n## Error Messages\n\nClear error messages for common issues:\n- \"webhook config file not found: %s\"\n- \"invalid webhook URL: must use HTTPS\"\n- \"webhook timeout %s exceeds maximum of 30s\"\n- \"TLS CA bundle file not found: %s\"\n- \"invalid HMAC secret reference format\"\n\n## Tests\n\n- Flag parsing tests\n- Config file loading tests (YAML and JSON)\n- Config merging tests\n- Validation tests (invalid URLs, missing required fields)\n- Integration test: `thv run` with webhook config\n\n## Documentation\n\nUpdate CLI documentation:\n- Add `--webhook-config` to `thv run --help`\n- Add example webhook config files to docs/examples/\n- Update docs/middleware.md with webhook middleware section\n\n## Acceptance Criteria\n\n- [ ] `--webhook-config` flag added to `thv run`\n- [ ] Supports YAML and JSON config formats\n- [ ] Multiple config files can be specified and merged\n- [ ] Clear validation error messages\n- [ ] Config correctly populates RunConfig\n- [ ] Unit tests with >80% coverage\n- [ ] CLI documentation updated\n- [ ] Code passes `task lint` and `task test`\n","closed":false,"closedAt":null,"closedByPullRequestsReferences":[],"comments":[],"createdAt":"2026-01-22T06:40:48Z","id":"I_kwDOOHdoXs7k-HkM","isPinned":false,"labels":[{"id":"LA_kwDOOHdoXs8AAAAB7bU01g","name":"enhancement","description":"New feature or request","color":"a2eeef"},{"id":"LA_kwDOOHdoXs8AAAACJiuvqw","name":"cli","description":"Changes that impact CLI functionality","color":"0ed856"}],"milestone":null,"number":3400,"reactionGroups":[],"state":"OPEN","stateReason":"","title":"Webhook Middleware Phase 4: CLI configuration support","updatedAt":"2026-01-22T06:42:40Z","url":"https://github.com/stacklok/toolhive/issues/3400"},{"assignees":[],"author":{"id":"MDQ6VXNlcjE0NTU2NA==","is_bot":false,"login":"JAORMX","name":"Juan Antonio Osorio"},"body":"## Summary\n\nOpenTelemetry officially merged MCP semantic conventions on January 12, 2026 ([PR #2083](https://github.com/open-telemetry/semantic-conventions/pull/2083)). ToolHive should align its telemetry implementation with these standards for better observability tool compatibility and ecosystem alignment.\n\n## Standard References\n\n- **Main Documentation**: [docs/gen-ai/mcp.md](https://github.com/open-telemetry/semantic-conventions/blob/main/docs/gen-ai/mcp.md)\n- **Attribute Registry**: [model/mcp/registry.yaml](https://github.com/open-telemetry/semantic-conventions/blob/main/model/mcp/registry.yaml)\n- **Metrics Definitions**: [model/mcp/metrics.yaml](https://github.com/open-telemetry/semantic-conventions/blob/main/model/mcp/metrics.yaml)\n- **W3C Trace Context**: [https://www.w3.org/TR/trace-context/](https://www.w3.org/TR/trace-context/)\n\n## Current State\n\nToolHive has solid telemetry foundation but predates the official conventions:\n- **Middleware**: `pkg/telemetry/middleware.go` - spans, attributes, metrics for MCP proxy\n- **vMCP**: `pkg/vmcp/server/telemetry.go` - backend and workflow telemetry  \n- **Parser**: `pkg/mcp/parser.go` - already extracts `_meta` field (lines 228-233)\n\n## Core Implementation Tasks\n\n### 1. Update Attributes and Span Naming\n\n**File**: `pkg/telemetry/middleware.go`\n\n**Attribute Renames** (for standard compliance):\n- `mcp.method` → `mcp.method.name` (line 222)\n- `mcp.request.id` → `jsonrpc.request.id` (line 229)\n- `mcp.tool.name` → `gen_ai.tool.name` (line 263)\n- `mcp.tool.arguments` → `gen_ai.tool.call.arguments` (line 267, opt-in)\n- `mcp.prompt.name` → `gen_ai.prompt.name` (line 279)\n- `mcp.transport` → `network.transport` with value mapping:\n  - `stdio` → `pipe`\n  - `sse`, `streamable-http` → `tcp`\n\n**Add Missing Required Attributes**:\n- `mcp.protocol.version` - MCP spec version (e.g., \"2025-11-25\")\n- `mcp.session.id` - Session identifier\n- `jsonrpc.protocol.version` - When not \"2.0\"\n- `error.type` - On failures (JSON-RPC error code or \"tool_error\")\n- `rpc.response.status_code` - When response contains error\n- `gen_ai.operation.name` - \"execute_tool\" for tool calls\n- `network.protocol.name` - \"http\" for SSE/streamable-http\n\n**Span Naming** (lines 161-170):\n- Current: `mcp.tools/call`\n- Standard: `tools/call get_weather` (include target when available)\n- Format: `{mcp.method.name} {target}` where target is tool/prompt name\n\n### 2. Add Standard Metrics\n\n**File**: `pkg/telemetry/middleware.go`\n\n**New Standard Metrics** (alongside existing):\n- `mcp.client.operation.duration` (histogram, seconds)\n- `mcp.server.operation.duration` (histogram, seconds)\n- Use recommended buckets: `[0.01, 0.02, 0.05, 0.1, 0.2, 0.5, 1, 2, 5, 10, 30, 60, 120, 300]`\n\n**Keep existing** `toolhive_mcp_*` metrics for backward compatibility.\n\n### 3. Implement W3C Trace Context Propagation\n\n**Critical Feature**: Enable distributed tracing across MCP boundaries.\n\n#### 3a. Context Injection (vMCP → Backends)\n\n**Files**: \n- New: `pkg/telemetry/propagation.go` - W3C Trace Context helpers\n- `pkg/vmcp/client/client.go` - Inject before backend calls\n\n**Implementation**: Inject `traceparent` and `tracestate` into `params._meta`:\n\n```json\n{\n  \"jsonrpc\": \"2.0\",\n  \"method\": \"tools/call\",\n  \"params\": {\n    \"name\": \"get-weather\",\n    \"_meta\": {\n      \"traceparent\": \"00-4bf92f3577b34da6a3ce929d0e0e4736-00f067aa0ba902b7-01\",\n      \"tracestate\": \"rojo=00f067aa0ba902b7\"\n    }\n  }\n}\n```\n\n**Code Structure**:\n```go\n// propagation.go\nfunc InjectTraceContext(ctx context.Context, params map[string]interface{}) {\n    meta := getOrCreateMeta(params)\n    carrier := &MetaCarrier{meta: meta}\n    otel.GetTextMapPropagator().Inject(ctx, carrier)\n}\n\ntype MetaCarrier struct {\n    meta map[string]interface{}\n}\n// Implement TextMapCarrier interface\n```\n\n#### 3b. Context Extraction (Clients → ToolHive)\n\n**File**: `pkg/telemetry/middleware.go` (around line 114)\n\n**Implementation**: Extract trace context from incoming `params._meta` and use as parent for server span:\n\n```go\nif parsedMCP := mcpparser.GetParsedMCPRequest(ctx); parsedMCP != nil && parsedMCP.Meta != nil {\n    carrier := &MetaCarrier{meta: parsedMCP.Meta}\n    ctx = otel.GetTextMapPropagator().Extract(ctx, carrier)\n}\n```\n\n### 4. Add Client-Side Spans for vMCP\n\n**File**: `pkg/vmcp/client/client.go`\n\n**Current**: Only SERVER spans when serving requests  \n**Needed**: CLIENT spans when vMCP calls backend MCP servers\n\n**Operations to Instrument**:\n- `initialize` - Protocol handshake\n- `tools/list`, `tools/call`\n- `resources/list`, `resources/read`\n- `prompts/list`, `prompts/get`\n\n**Span Kind**: Use `trace.SpanKindClient` for these operations.\n\n### 5. Add Session Duration Metrics\n\n**Files**:\n- `pkg/vmcp/server/session_adapter.go` - Track session lifecycle\n- Proxy components - Track session termination\n\n**Metrics**:\n- `mcp.client.session.duration` (histogram, seconds)\n- `mcp.server.session.duration` (histogram, seconds)\n\n**Attributes**:\n- `mcp.protocol.version`\n- `network.protocol.name`\n- `network.transport`\n- `error.type` (if session terminated with error)\n\n## Backward Compatibility\n\n**Approach**: Emit both legacy and standard names during transition period.\n\n**Configuration**: Add optional flag:\n```yaml\ntelemetry:\n  useLegacyAttributes: false  # default: standard only\n```\n\n**CLI Flag**: `--otel-use-legacy-attributes` (enables dual emission)\n\n**Timeline**:\n- Ship standard-compliant attributes/metrics immediately\n- Announce deprecation after 6 months\n- Remove legacy support in v2.0\n\n## Components Affected\n\n- `pkg/telemetry/middleware.go` - MCP proxy telemetry (spans, metrics, attributes)\n- `pkg/telemetry/propagation.go` - New file for trace context helpers\n- `pkg/vmcp/client/client.go` - CLIENT spans and context injection\n- `pkg/vmcp/server/session_adapter.go` - Session duration tracking\n- `pkg/telemetry/config.go` - Backward compatibility configuration\n- `cmd/thv-operator/api/v1alpha1/*_types.go` - CRD telemetry specs\n- `docs/observability.md` - Update documentation\n- Test files: Update assertions for new attribute names\n\n## Testing Requirements\n\n- Update test expectations in `pkg/telemetry/middleware_test.go`\n- Update E2E tests in `test/e2e/telemetry_middleware_e2e_test.go`\n- Add trace propagation E2E test (vMCP → backend → vMCP chain)\n- Validate span hierarchy (CLIENT/SERVER relationship)\n- Test session duration tracking\n- Verify histogram buckets\n\n## Success Criteria\n\n- [ ] All required attributes emitted per standard\n- [ ] Span names follow `{method} {target}` format\n- [ ] Standard metrics recorded with correct units/attributes\n- [ ] W3C Trace Context propagates through `params._meta`\n- [ ] CLIENT spans created for vMCP backend calls\n- [ ] Session duration metrics tracked\n- [ ] Network transport values mapped correctly (stdio→pipe, http→tcp)\n- [ ] Documentation updated\n- [ ] Backward compatibility maintained (with flag)\n- [ ] No performance regression\n\n## References\n\n- **OTel MCP PR**: https://github.com/open-telemetry/semantic-conventions/pull/2083\n- **Implementation Examples**:\n  - .NET: https://github.com/modelcontextprotocol/csharp-sdk/pull/262\n  - Python: https://github.com/mayankagarwals/openllmetry/tree/main/packages/opentelemetry-instrumentation-mcp\n- **Related Issue**: Mentioned in team discussion about enhancing ToolHive telemetry","closed":false,"closedAt":null,"closedByPullRequestsReferences":[],"comments":[],"createdAt":"2026-01-22T06:39:59Z","id":"I_kwDOOHdoXs7k-G-Q","isPinned":false,"labels":[{"id":"LA_kwDOOHdoXs8AAAAB7bU01g","name":"enhancement","description":"New feature or request","color":"a2eeef"},{"id":"LA_kwDOOHdoXs8AAAAB828HLQ","name":"go","description":"Pull requests that update go code","color":"16e2e2"},{"id":"LA_kwDOOHdoXs8AAAACJiuvqw","name":"cli","description":"Changes that impact CLI functionality","color":"0ed856"},{"id":"LA_kwDOOHdoXs8AAAACJiu1Bw","name":"api","description":"Items related to the API","color":"b404c2"},{"id":"LA_kwDOOHdoXs8AAAACLpzsvg","name":"telemetry","description":"","color":"aaaaaa"},{"id":"LA_kwDOOHdoXs8AAAACNqqAVQ","name":"operator","description":"","color":"ededed"},{"id":"LA_kwDOOHdoXs8AAAACVoFHJw","name":"observability","description":"","color":"ededed"}],"milestone":null,"number":3399,"reactionGroups":[],"state":"OPEN","stateReason":"","title":"Align telemetry with OpenTelemetry MCP semantic conventions","updatedAt":"2026-01-22T06:40:52Z","url":"https://github.com/stacklok/toolhive/issues/3399"},{"assignees":[],"author":{"id":"MDQ6VXNlcjE0NTU2NA==","is_bot":false,"login":"JAORMX","name":"Juan Antonio Osorio"},"body":"## Overview\n\nImplement mutating webhook middleware that calls external HTTP services to transform MCP requests using JSONPatch (RFC 6902). This enables organizations to enrich requests with data from external sources (HR systems, CMDB, project databases) without modifying ToolHive code.\n\n**RFC**: https://github.com/stacklok/toolhive-rfcs/blob/main/rfcs/THV-0017-dynamic-webhook-middleware.md\n\n**Depends on**: Phase 1 (Core webhook package)\n\n## Files to Create\n\n| File | Purpose |\n|------|---------|\n| `pkg/webhook/mutating/middleware.go` | Mutating webhook middleware implementation |\n| `pkg/webhook/mutating/config.go` | Configuration types and validation |\n| `pkg/webhook/mutating/patch.go` | JSONPatch application and validation |\n\n## Files to Modify\n\n| File | Changes |\n|------|---------|\n| `pkg/runner/middleware.go` | Register `mutating-webhook` in `GetSupportedMiddlewareFactories()` |\n| `pkg/runner/config.go` | Add `MutatingWebhooks []webhook.WebhookConfig` field to RunConfig |\n\n## Middleware Implementation\n\n```go\n// pkg/webhook/mutating/middleware.go\nconst MiddlewareType = \"mutating-webhook\"\n\ntype MiddlewareParams struct {\n    Webhooks []webhook.WebhookConfig `json:\"webhooks\"`\n}\n\nfunc CreateMiddleware(config *types.MiddlewareConfig, runner types.MiddlewareRunner) error {\n    // 1. Parse params\n    // 2. Create HTTP client\n    // 3. Build middleware function that:\n    //    - Gets parsed MCP request from context\n    //    - Builds webhook request\n    //    - Calls each webhook in order\n    //    - Applies JSONPatch operations to mcp_request\n    //    - Updates request context/body with mutated request\n    //    - Handle failures per FailurePolicy\n    // 4. Register with runner.AddMiddleware()\n}\n```\n\n## Request/Response Format\n\n**Request to webhook** (POST):\n```json\n{\n  \"version\": \"v0.1.0\",\n  \"uid\": \"unique-request-id\",\n  \"timestamp\": \"2025-01-22T10:30:00Z\",\n  \"principal\": {\n    \"sub\": \"user123\",\n    \"email\": \"user@example.com\"\n  },\n  \"mcp_request\": {\n    \"jsonrpc\": \"2.0\",\n    \"id\": 1,\n    \"method\": \"tools/call\",\n    \"params\": {\n      \"name\": \"database_query\",\n      \"arguments\": {\n        \"query\": \"SELECT * FROM users\"\n      }\n    }\n  },\n  \"context\": {\n    \"server_name\": \"my-mcp-server\",\n    \"transport\": \"sse\"\n  }\n}\n```\n\n**Response (with JSONPatch)**:\n```json\n{\n  \"version\": \"v0.1.0\",\n  \"uid\": \"unique-request-id\",\n  \"allowed\": true,\n  \"patch_type\": \"json_patch\",\n  \"patch\": [\n    {\n      \"op\": \"add\",\n      \"path\": \"/mcp_request/params/arguments/audit_user\",\n      \"value\": \"user@example.com\"\n    },\n    {\n      \"op\": \"add\",\n      \"path\": \"/mcp_request/params/arguments/department\",\n      \"value\": \"engineering\"\n    }\n  ]\n}\n```\n\n## JSONPatch Implementation\n\nUse `github.com/evanphx/json-patch/v5` library for RFC 6902 compliance.\n\n**Supported operations**:\n- `add` - Add value at path\n- `remove` - Remove value at path\n- `replace` - Replace value at path\n- `copy` - Copy value from one path to another\n- `move` - Move value from one path to another\n- `test` - Test value at path (for conditional patches)\n\n**Security constraint**: Patches are scoped to the `mcp_request` container only. Attempts to modify `principal`, `context`, or other fields should be rejected.\n\n```go\n// pkg/webhook/mutating/patch.go\nfunc ApplyPatch(original []byte, patch []JSONPatchOp) ([]byte, error)\nfunc ValidatePatch(patch []JSONPatchOp) error\nfunc IsPatchScopedToMCPRequest(patch []JSONPatchOp) bool\n```\n\n## Middleware Chain Position\n\nMutating webhooks should be placed after MCP Parser and before Validating webhooks:\n\n```\nAuth -> Token Exchange -> Tool Filter -> MCP Parser ->\n[Mutating Webhooks] -> [Validating Webhooks] -> Telemetry -> Authorization -> Audit -> Recovery\n```\n\n## Failure Policies\n\n| Policy | Behavior on webhook error |\n|--------|---------------------------|\n| `fail` (fail-closed) | Deny request with 500 |\n| `ignore` (fail-open) | Use original (unmutated) request |\n\n## Multiple Webhooks\n\nWhen multiple mutating webhooks are configured:\n1. Execute in configuration order\n2. Each webhook receives the output of the previous mutation\n3. Patches are applied sequentially\n4. Failure policy applies per-webhook\n\n## Tests\n\n- JSONPatch application tests for all operations\n- Tests for invalid/malformed patches\n- Tests for patch scope validation (reject modifications outside mcp_request)\n- Tests for multiple webhooks with chained mutations\n- Tests for failure policies\n- Integration tests with middleware chain\n\n## Acceptance Criteria\n\n- [ ] Middleware registered in `GetSupportedMiddlewareFactories()`\n- [ ] Correctly calls webhooks with RFC-compliant request format\n- [ ] Applies JSONPatch operations correctly\n- [ ] Validates patch scope (mcp_request only)\n- [ ] Implements both failure policies\n- [ ] Supports multiple webhooks with chained mutations\n- [ ] Comprehensive unit tests with >80% coverage\n- [ ] Code passes `task lint` and `task test`\n","closed":false,"closedAt":null,"closedByPullRequestsReferences":[],"comments":[],"createdAt":"2026-01-22T06:39:04Z","id":"I_kwDOOHdoXs7k-GXe","isPinned":false,"labels":[{"id":"LA_kwDOOHdoXs8AAAAB7bU01g","name":"enhancement","description":"New feature or request","color":"a2eeef"},{"id":"LA_kwDOOHdoXs8AAAAB828HLQ","name":"go","description":"Pull requests that update go code","color":"16e2e2"},{"id":"LA_kwDOOHdoXs8AAAACCmVMRg","name":"authentication","description":"","color":"ededed"},{"id":"LA_kwDOOHdoXs8AAAACJiu1Bw","name":"api","description":"Items related to the API","color":"b404c2"}],"milestone":null,"number":3398,"reactionGroups":[],"state":"OPEN","stateReason":"","title":"Webhook Middleware Phase 3: Mutating webhook middleware with JSONPatch","updatedAt":"2026-01-22T06:40:52Z","url":"https://github.com/stacklok/toolhive/issues/3398"},{"assignees":[],"author":{"id":"MDQ6VXNlcjE0NTU2NA==","is_bot":false,"login":"JAORMX","name":"Juan Antonio Osorio"},"body":"## Overview\n\nImplement validating webhook middleware that calls external HTTP services to approve or deny MCP requests. This middleware allows organizations to plug in external policy engines, approval workflows, or rate limiters.\n\n**RFC**: https://github.com/stacklok/toolhive-rfcs/blob/main/rfcs/THV-0017-dynamic-webhook-middleware.md\n\n**Depends on**: Phase 1 (Core webhook package)\n\n## Files to Create\n\n| File | Purpose |\n|------|---------|\n| `pkg/webhook/validating/middleware.go` | Validating webhook middleware implementation |\n| `pkg/webhook/validating/config.go` | Configuration types and validation |\n\n## Files to Modify\n\n| File | Changes |\n|------|---------|\n| `pkg/runner/middleware.go` | Register `validating-webhook` in `GetSupportedMiddlewareFactories()` |\n| `pkg/runner/config.go` | Add `ValidatingWebhooks []webhook.WebhookConfig` field to RunConfig |\n\n## Middleware Implementation\n\n```go\n// pkg/webhook/validating/middleware.go\nconst MiddlewareType = \"validating-webhook\"\n\ntype MiddlewareParams struct {\n    Webhooks []webhook.WebhookConfig `json:\"webhooks\"`\n}\n\ntype Middleware struct {\n    client     *webhook.Client\n    webhooks   []webhook.WebhookConfig\n    middleware types.MiddlewareFunction\n}\n\nfunc (m *Middleware) Handler() types.MiddlewareFunction {\n    return m.middleware\n}\n\nfunc (m *Middleware) Close() error {\n    return nil\n}\n\nfunc CreateMiddleware(config *types.MiddlewareConfig, runner types.MiddlewareRunner) error {\n    // Implementation\n}\n```\n\n## Request/Response Format\n\n**Request to webhook** (POST):\n```json\n{\n  \"version\": \"v0.1.0\",\n  \"uid\": \"unique-request-id\",\n  \"timestamp\": \"2025-01-22T10:30:00Z\",\n  \"principal\": {\n    \"sub\": \"user123\",\n    \"email\": \"user@example.com\",\n    \"groups\": [\"engineering\"]\n  },\n  \"mcp_request\": {\n    \"method\": \"tools/call\",\n    \"params\": { \"name\": \"database_query\", \"arguments\": {...} }\n  },\n  \"context\": {\n    \"server_name\": \"my-mcp-server\",\n    \"transport\": \"sse\",\n    \"source_ip\": \"192.0.2.1\"\n  }\n}\n```\n\n**Response (allowed)**:\n```json\n{\n  \"version\": \"v0.1.0\",\n  \"uid\": \"unique-request-id\",\n  \"allowed\": true\n}\n```\n\n**Response (denied)**:\n```json\n{\n  \"version\": \"v0.1.0\",\n  \"uid\": \"unique-request-id\",\n  \"allowed\": false,\n  \"code\": 403,\n  \"message\": \"Production writes require approval\",\n  \"reason\": \"RequiresApproval\",\n  \"details\": {\n    \"ticket_url\": \"https://tickets.example.com/PROD-1234\"\n  }\n}\n```\n\n## Middleware Chain Position\n\nValidating webhooks should be placed after MCP Parser and before Authorization:\n\n```\nAuth -> Token Exchange -> Tool Filter -> MCP Parser ->\n[Mutating Webhooks] -> [Validating Webhooks] -> Telemetry -> Authorization -> Audit -> Recovery\n```\n\n## Failure Policies\n\n| Policy | Behavior on webhook error |\n|--------|---------------------------|\n| `fail` (fail-closed) | Deny request with 403 |\n| `ignore` (fail-open) | Allow request to continue |\n\nError conditions:\n- Network errors\n- Timeout\n- HTTP 5xx from webhook\n- Invalid JSON response\n- Missing required fields\n\n## Multiple Webhooks\n\nWhen multiple validating webhooks are configured:\n1. Execute in configuration order\n2. If ANY webhook returns `allowed: false`, deny the request\n3. If ALL webhooks return `allowed: true`, allow the request\n4. Failure policy applies per-webhook\n\n## Tests\n\n- Unit tests with mock webhook servers (use `httptest`)\n- Tests for `allowed=true` and `allowed=false` responses\n- Tests for failure policies (fail-closed, fail-open)\n- Tests for multiple webhooks in chain\n- Tests for timeout handling\n- Tests for invalid response handling\n- Integration tests with middleware chain\n\n## Acceptance Criteria\n\n- [ ] Middleware registered in `GetSupportedMiddlewareFactories()`\n- [ ] Correctly calls webhooks with RFC-compliant request format\n- [ ] Handles `allowed: true/false` responses correctly\n- [ ] Implements both failure policies\n- [ ] Supports multiple webhooks in chain\n- [ ] Comprehensive unit tests with >80% coverage\n- [ ] Integration test with full middleware chain\n- [ ] Code passes `task lint` and `task test`\n","closed":false,"closedAt":null,"closedByPullRequestsReferences":[],"comments":[],"createdAt":"2026-01-22T06:38:40Z","id":"I_kwDOOHdoXs7k-GG3","isPinned":false,"labels":[{"id":"LA_kwDOOHdoXs8AAAAB7bU01g","name":"enhancement","description":"New feature or request","color":"a2eeef"},{"id":"LA_kwDOOHdoXs8AAAAB828HLQ","name":"go","description":"Pull requests that update go code","color":"16e2e2"},{"id":"LA_kwDOOHdoXs8AAAACCmVMRg","name":"authentication","description":"","color":"ededed"},{"id":"LA_kwDOOHdoXs8AAAACJiu1Bw","name":"api","description":"Items related to the API","color":"b404c2"}],"milestone":null,"number":3397,"reactionGroups":[],"state":"OPEN","stateReason":"","title":"Webhook Middleware Phase 2: Validating webhook middleware","updatedAt":"2026-01-22T06:39:29Z","url":"https://github.com/stacklok/toolhive/issues/3397"},{"assignees":[],"author":{"id":"MDQ6VXNlcjE0NTU2NA==","is_bot":false,"login":"JAORMX","name":"Juan Antonio Osorio"},"body":"## Overview\n\nImplement the foundational webhook package for the Dynamic Webhook Middleware feature. This phase creates the core types, HTTP client, and HMAC signing functionality that will be used by both validating and mutating webhook middleware.\n\n**RFC**: https://github.com/stacklok/toolhive-rfcs/blob/main/rfcs/THV-0017-dynamic-webhook-middleware.md\n\n## Files to Create\n\n| File | Purpose |\n|------|---------|\n| `pkg/webhook/types.go` | Core types: `WebhookType`, `FailurePolicy`, `WebhookConfig`, request/response structs |\n| `pkg/webhook/client.go` | HTTP client for calling webhooks with TLS/timeout support |\n| `pkg/webhook/signing.go` | HMAC-SHA256 payload signing (`X-ToolHive-Signature` header) |\n| `pkg/webhook/errors.go` | Error types: timeout, network, validation errors |\n\n## Key Types\n\n```go\n// pkg/webhook/types.go\ntype WebhookType string\nconst (\n    WebhookTypeValidating WebhookType = \"validating\"\n    WebhookTypeMutating   WebhookType = \"mutating\"\n)\n\ntype FailurePolicy string\nconst (\n    FailurePolicyFail   FailurePolicy = \"fail\"   // fail-closed\n    FailurePolicyIgnore FailurePolicy = \"ignore\" // fail-open\n)\n\ntype WebhookConfig struct {\n    Name          string        `json:\"name\"`\n    URL           string        `json:\"url\"`\n    Timeout       time.Duration `json:\"timeout\"`\n    FailurePolicy FailurePolicy `json:\"failure_policy\"`\n    TLSConfig     *TLSConfig    `json:\"tls_config,omitempty\"`\n    HMACSecretRef string        `json:\"hmac_secret_ref,omitempty\"`\n}\n\ntype WebhookRequest struct {\n    Version    string           `json:\"version\"` // \"v0.1.0\"\n    UID        string           `json:\"uid\"`\n    Timestamp  time.Time        `json:\"timestamp\"`\n    Principal  *Principal       `json:\"principal\"`\n    MCPRequest json.RawMessage  `json:\"mcp_request\"`\n    Context    *RequestContext  `json:\"context\"`\n}\n\ntype Principal struct {\n    Sub    string            `json:\"sub\"`\n    Email  string            `json:\"email,omitempty\"`\n    Name   string            `json:\"name,omitempty\"`\n    Groups []string          `json:\"groups,omitempty\"`\n    Claims map[string]string `json:\"claims,omitempty\"`\n}\n\ntype RequestContext struct {\n    ServerName    string `json:\"server_name\"`\n    BackendServer string `json:\"backend_server,omitempty\"`\n    Namespace     string `json:\"namespace,omitempty\"`\n    SourceIP      string `json:\"source_ip\"`\n    Transport     string `json:\"transport\"`\n}\n```\n\n## HTTP Client Features\n\n- TLS configuration (CA bundles, skip verify for dev)\n- mTLS support (client certificates)\n- Configurable timeouts\n- Connection pooling\n- Use existing patterns from `pkg/networking/http_client.go`\n\n## HMAC Signing\n\nPer RFC, implement HMAC-SHA256 signing:\n- Header: `X-ToolHive-Signature: sha256=<hex-encoded-signature>`\n- Header: `X-ToolHive-Timestamp: <unix-timestamp>`\n- Signature computed over: `timestamp.payload`\n\n```go\nfunc SignPayload(secret []byte, timestamp int64, payload []byte) string\nfunc VerifySignature(secret []byte, timestamp int64, payload []byte, signature string) bool\n```\n\n## Error Types\n\n```go\ntype WebhookError struct {\n    WebhookName string\n    Err         error\n}\n\ntype TimeoutError struct{ WebhookError }\ntype NetworkError struct{ WebhookError }\ntype InvalidResponseError struct{ WebhookError }\n```\n\n## Tests\n\n- Unit tests for HMAC signing/verification\n- HTTP client tests with mock servers (use `httptest`)\n- Error handling tests (timeout, TLS errors, invalid responses)\n- Table-driven tests for various error conditions\n\n## Acceptance Criteria\n\n- [ ] All types defined per RFC specification\n- [ ] HTTP client supports TLS, mTLS, and configurable timeouts\n- [ ] HMAC signing matches RFC specification\n- [ ] Comprehensive unit tests with >80% coverage\n- [ ] Code passes `task lint` and `task test`\n","closed":false,"closedAt":null,"closedByPullRequestsReferences":[],"comments":[],"createdAt":"2026-01-22T06:37:59Z","id":"I_kwDOOHdoXs7k-FnO","isPinned":false,"labels":[{"id":"LA_kwDOOHdoXs8AAAAB7bU01g","name":"enhancement","description":"New feature or request","color":"a2eeef"},{"id":"LA_kwDOOHdoXs8AAAAB828HLQ","name":"go","description":"Pull requests that update go code","color":"16e2e2"},{"id":"LA_kwDOOHdoXs8AAAACCmVMRg","name":"authentication","description":"","color":"ededed"},{"id":"LA_kwDOOHdoXs8AAAACJiu1Bw","name":"api","description":"Items related to the API","color":"b404c2"}],"milestone":null,"number":3396,"reactionGroups":[],"state":"OPEN","stateReason":"","title":"Webhook Middleware Phase 1: Core webhook package (types, HTTP client, HMAC signing)","updatedAt":"2026-01-22T06:38:49Z","url":"https://github.com/stacklok/toolhive/issues/3396"},{"assignees":[],"author":{"id":"MDQ6VXNlcjcxNTUyMg==","is_bot":false,"login":"jhrozek","name":"Jakub Hrozek"},"body":"## Summary\n\nWhen using token exchange with a corporate IdP that uses internal/custom CA certificates, users cannot configure a CA bundle for the token exchange HTTP client. The OIDC configuration supports `CABundleRef`, but the `TokenExchangeConfig` in `MCPExternalAuthConfig` does not.\n\n## Problem\n\nThe token exchange HTTP client (`pkg/auth/tokenexchange/exchange.go`) uses only system CAs:\n\n```go\nvar defaultHTTPClient = &http.Client{\n    Timeout: defaultHTTPTimeout,\n}\n```\n\nIf a corporate IdP's token endpoint uses a certificate signed by an internal CA, token exchange requests will fail with TLS verification errors.\n\n## Proposed Solution\n\nAdd `CABundleRef` support to `TokenExchangeConfig`:\n\n### Files to Modify\n\n1. **CRD** (`cmd/thv-operator/api/v1alpha1/mcpexternalauthconfig_types.go`):\n   - Add `CABundleRef *CABundleSource` to `TokenExchangeConfig` struct\n\n2. **Core package** (`pkg/auth/tokenexchange/middleware.go`):\n   - Add `CACertPath string` field to `Config` struct\n\n3. **Token exchange client** (`pkg/auth/tokenexchange/exchange.go`):\n   - Modify `createTokenExchangeMiddleware()` to create an HTTP client with CA bundle support using `networking.NewHttpClientBuilder().WithCABundle()`\n\n4. **Operator utilities** (`cmd/thv-operator/pkg/controllerutil/tokenexchange.go`):\n   - Resolve CA bundle path from `CABundleRef`\n   - Add validation for `CABundleRef`\n\n5. **Volume mounting** (deployment controllers):\n   - Mount CA bundle ConfigMap as volume for token exchange\n\n6. **Runner config** (`pkg/runner/options.go`):\n   - Update `WithTokenExchangeConfig()` to accept CA cert path\n\n7. **Tests and documentation**\n\n## Related\n\nThis is similar to the `CABundleRef` support added for `InlineOIDCConfig` and `ConfigMapOIDCRef` in the OIDC configuration.\n\n## Acceptance Criteria\n\n- [ ] `TokenExchangeConfig` CRD has `caBundleRef` field\n- [ ] Token exchange HTTP client uses configured CA bundle\n- [ ] Volume mounting works for CA bundle ConfigMap\n- [ ] Unit tests cover CA bundle path resolution\n- [ ] CRD documentation updated","closed":false,"closedAt":null,"closedByPullRequestsReferences":[],"comments":[],"createdAt":"2026-01-21T21:30:59Z","id":"I_kwDOOHdoXs7k441a","isPinned":false,"labels":[{"id":"LA_kwDOOHdoXs8AAAAB7bU01g","name":"enhancement","description":"New feature or request","color":"a2eeef"},{"id":"LA_kwDOOHdoXs8AAAAB828HLQ","name":"go","description":"Pull requests that update go code","color":"16e2e2"},{"id":"LA_kwDOOHdoXs8AAAAB9PXLvA","name":"kubernetes","description":"Items related to Kubernetes","color":"0000FF"},{"id":"LA_kwDOOHdoXs8AAAACCmVMRg","name":"authentication","description":"","color":"ededed"},{"id":"LA_kwDOOHdoXs8AAAACNqqAVQ","name":"operator","description":"","color":"ededed"}],"milestone":null,"number":3388,"reactionGroups":[],"state":"OPEN","stateReason":"","title":"Add CABundleRef support to TokenExchangeConfig in MCPExternalAuthConfig","updatedAt":"2026-01-21T21:32:12Z","url":"https://github.com/stacklok/toolhive/issues/3388"},{"assignees":[{"id":"MDQ6VXNlcjEwNTMyMTgx","login":"jerm-dro","name":"Jeremy Drouillard","databaseId":0}],"author":{"id":"MDQ6VXNlcjEwNTMyMTgx","is_bot":false,"login":"jerm-dro","name":"Jeremy Drouillard"},"body":"## Bug description\n\nWhen the Docker daemon becomes unavailable while a ToolHive stdio transport proxy is running, the transport enters a \"zombie\" state where it appears to be running but cannot communicate with the container. The proxy continues accepting requests but is unable to forward them, and the automatic restart mechanism is not triggered.\n\nThis affects workloads using the **stdio transport** .\n\n## Steps to reproduce\n\n1. Start a ToolHive MCP server using stdio transport:\n   ```bash\n   thv run --name test-server ghcr.io/some/mcp-server\n   ```\n\n2. While the server is running, make the Docker daemon unavailable (e.g., stop the Docker service, or simulate network issues to the Docker socket)\n\n3. The container's stdout pipe will close, triggering the stdio transport's re-attachment logic\n\n4. Re-attachment fails because Docker is unavailable\n\n5. Observe that:\n   - The proxy runner continues running\n   - `IsRunning()` returns `true`\n   - The proxy accepts HTTP requests but cannot forward them to the container\n   - No automatic restart is triggered\n\n## Expected behavior\n\nWhen stdio transport re-attachment fails due to Docker being unavailable, the transport should:\n1. Call `Stop()` to properly shut down\n2. Close the shutdown channel so `IsRunning()` returns `false`\n3. Allow the monitoring loop in `Runner.Run()` to detect the stopped transport\n4. Trigger the automatic restart flow with exponential backoff\n\n## Actual behavior\n\nWhen stdio transport re-attachment fails:\n1. `processStdout` exits its read loop but does NOT call `Stop()`\n2. `processMessages` continues running\n3. The HTTP proxy continues accepting requests\n4. `IsRunning()` returns `true` (shutdown channel is still open)\n5. The monitoring loop never detects that the transport has stopped\n6. The system remains in a zombie state indefinitely\n\n## Workaround\n\nThe workload must be manually stopped and restarted.\n\n## Environment (if relevant)\n- OS/version: macOS / Linux\n- ToolHive version: All versions with stdio transport re-attachment logic\n\n## Additional context\n\nThe issue is in `pkg/transport/stdio.go` in the `processStdout` function. After `attemptReattachment` fails and returns `false`, the function logs \"Container stdout closed - exiting read loop\" and returns, but it does not call `t.Stop(ctx)` to properly shut down the transport.\n\n**Relevant log output showing the time gap between stdout closing and transport shutdown:**\n```\n2025-05-29T00:50:09.464Z WARN Container stdout closed - checking if container is still running\n2025-05-29T00:50:09.504Z WARN Docker socket unavailable (attempt 1/3), will retry: Cannot connect to the Docker daemon\n...\n2025-05-29T00:50:09.574Z WARN Failed to re-attach after all retry attempts\n2025-05-29T00:50:09.574Z INFO Container stdout closed - exiting read loop\n[... 13+ minutes of zombie state ...]\n2025-05-29T01:03:55.447Z INFO Stopping stdio transport\n```\n\n**Fix:** Add a call to `t.Stop(ctx)` after the \"exiting read loop\" log message in `processStdout` so the stdio transport properly shuts down when re-attachment fails.","closed":false,"closedAt":null,"closedByPullRequestsReferences":[{"id":"PR_kwDOOHdoXs6-h-Ia","number":3384,"repository":{"id":"R_kgDOOHdoXg","name":"toolhive","owner":{"id":"O_kgDOBpIYMg","login":"stacklok"}},"url":"https://github.com/stacklok/toolhive/pull/3384"}],"comments":[{"id":"IC_kwDOOHdoXs7hZ1rc","author":{"login":"jerm-dro"},"authorAssociation":"MEMBER","body":"> Start a ToolHive MCP server using stdio transport:\nthv run --name test-server ghcr.io/some/mcp-server\nWhile the server is running, make the Docker daemon unavailable (e.g., stop the Docker service, or simulate network issues to the Docker socket)\nThe container's stdout pipe will close, triggering the stdio transport's re-attachment logic\nRe-attachment fails because Docker is unavailable\nObserve that:\nThe proxy runner continues running\nIsRunning() returns true\nThe proxy accepts HTTP requests but cannot forward them to the container\nNo automatic restart is triggered\n\n\nI attempted a reproduction with these steps without success. The proxy recreates the backend pod once docker is available again.","createdAt":"2026-01-21T23:40:12Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/stacklok/toolhive/issues/3383#issuecomment-3781647068","viewerDidAuthor":false}],"createdAt":"2026-01-21T19:35:23Z","id":"I_kwDOOHdoXs7k3Zky","isPinned":false,"labels":[{"id":"LA_kwDOOHdoXs8AAAAB7bU0xQ","name":"bug","description":"Something isn't working","color":"d73a4a"},{"id":"LA_kwDOOHdoXs8AAAAB828HLQ","name":"go","description":"Pull requests that update go code","color":"16e2e2"},{"id":"LA_kwDOOHdoXs8AAAACCmVMRw","name":"proxy","description":"","color":"ededed"},{"id":"LA_kwDOOHdoXs8AAAACJiuvqw","name":"cli","description":"Changes that impact CLI functionality","color":"0ed856"}],"milestone":null,"number":3383,"reactionGroups":[],"state":"OPEN","stateReason":"","title":"[BUG] stdio: transport enters zombie state when re-attachment fails","updatedAt":"2026-01-21T23:40:12Z","url":"https://github.com/stacklok/toolhive/issues/3383"},{"assignees":[],"author":{"id":"MDQ6VXNlcjY1OTk4MDM=","is_bot":false,"login":"eleftherias","name":"Eleftheria Stein-Kousathana"},"body":"## Bug description\nWhen running \n```\nthv run --remote-auth-skip-browser\n```\nI expect to see the log\n```\nPlease open this URL in your browser:\n```\n\nHowever, the foreground process exits too quickly and it's not possible to see the log unless I open the `.log` file.\nThis makes it difficult to log in to remote servers when my shell doesn't have permissions to open a browser.\n\n## Steps to reproduce\n```\nthv run context7-remote --remote-auth-skip-browser\n```\n\n## Expected behavior\nI expect to see the login URL printed:\n```\nPlease open this URL in your browser: https://context7.com/api/oauth/authorize?client_id=...\n```\nOr another mechanism that allows me to continue the OAuth flow.\n\n## Actual behavior\n`thv run` return immediately. The log with the URL is only available when searching through the log file.\n\n## Additional context\nThis problem becomes more painful given the 30s timeout when connecting to remote servers.","closed":false,"closedAt":null,"closedByPullRequestsReferences":[],"comments":[],"createdAt":"2026-01-21T16:11:50Z","id":"I_kwDOOHdoXs7k0hM6","isPinned":false,"labels":[{"id":"LA_kwDOOHdoXs8AAAAB7bU0xQ","name":"bug","description":"Something isn't working","color":"d73a4a"},{"id":"LA_kwDOOHdoXs8AAAACCmVMRg","name":"authentication","description":"","color":"ededed"},{"id":"LA_kwDOOHdoXs8AAAACJiuvqw","name":"cli","description":"Changes that impact CLI functionality","color":"0ed856"}],"milestone":null,"number":3377,"reactionGroups":[],"state":"OPEN","stateReason":"","title":"OAuth login URL is not shown when running remote server with auth","updatedAt":"2026-01-21T16:13:06Z","url":"https://github.com/stacklok/toolhive/issues/3377"},{"assignees":[],"author":{"id":"U_kgDOC6077g","is_bot":false,"login":"amirejaz","name":"Muhammad Amir Ejaz"},"body":"## Problem\n\nThe transparent proxy currently rewrites SSE endpoint URLs in responses to include the configured `endpointPrefix`, but it doesn't strip the prefix from incoming request paths before forwarding to the backend MCP server.\n\nThis causes issues in two scenarios:\n\n1. **Direct client access**: When a client makes a request directly to the proxy with the prefix (e.g., `/playwright/sse`), the proxy forwards it as-is to the backend, which expects `/sse` without the prefix.\n\n2. **Ingress without prefix stripping**: When an ingress controller doesn't strip the prefix before forwarding, the backend receives requests with the prefix that it doesn't expect.\n\n### Current Behavior\n\n- SSE response URLs are rewritten with prefix: `/sse` → `/playwright/sse` ✓\n- Request paths are forwarded as-is: `/playwright/sse` → backend receives `/playwright/sse` ✗\n\n### Expected Behavior\n\n- If ingress already stripped the prefix (detected via `X-Forwarded-Prefix` header), proxy should not strip again\n- If ingress didn't strip OR client makes direct request, proxy should strip the prefix before forwarding\n- Backend should always receive paths without the prefix: `/playwright/sse` → `/sse`\n\n## Solution\n\nImplement prefix stripping in the proxy's `Director` function that:\n- Strips `endpointPrefix` from request paths when present at the start\n- Detects if ingress already stripped via `X-Forwarded-Prefix` header (when `trustProxyHeaders` is enabled)\n- Handles edge cases like prefix appearing later in path (e.g., `/abc/abc/sse` with prefix `/abc` → `/abc/sse`)\n\n## Related\n\n- Affects: SSE transport with `endpointPrefix` configuration\n- Related to: Ingress path-based routing scenarios\n- Implementation: `pkg/transport/proxy/transparent/transparent_proxy.go`","closed":false,"closedAt":null,"closedByPullRequestsReferences":[],"comments":[],"createdAt":"2026-01-21T14:16:21Z","id":"I_kwDOOHdoXs7kyna2","isPinned":false,"labels":[{"id":"LA_kwDOOHdoXs8AAAAB7bU0xQ","name":"bug","description":"Something isn't working","color":"d73a4a"},{"id":"LA_kwDOOHdoXs8AAAAB828HLQ","name":"go","description":"Pull requests that update go code","color":"16e2e2"},{"id":"LA_kwDOOHdoXs8AAAACCmVMRw","name":"proxy","description":"","color":"ededed"}],"milestone":null,"number":3372,"reactionGroups":[],"state":"OPEN","stateReason":"","title":"Strip endpointPrefix from request paths in transparent proxy","updatedAt":"2026-01-21T14:17:22Z","url":"https://github.com/stacklok/toolhive/issues/3372"},{"assignees":[],"author":{"id":"MDQ6VXNlcjI5NTQxNDg1","is_bot":false,"login":"ChrisJBurns","name":"Chris Burns"},"body":"## Overview\n\nAdd integration tests for MCPServer edge cases and scenarios involving MCPToolConfig, which is used in conjunction with MCPServer.\n\n## Priority\n\n**Medium** - Extends existing MCPServer coverage with edge cases and MCPToolConfig integration.\n\n## Test Scenarios to Implement\n\n### ServiceAccount Handling\n- [ ] ServiceAccount override behavior\n- [ ] Default ServiceAccount creation\n- [ ] Custom ServiceAccount reference\n\n### Transport Types\n- [ ] Multiple transport type support\n- [ ] Transport configuration validation\n- [ ] Transport-specific settings\n\n### Port Configuration\n- [ ] Port configuration variations\n- [ ] Custom port mappings\n- [ ] Port conflict handling\n\n### Volume Mounts\n- [ ] Volume mount validation\n- [ ] Secret volume mounts\n- [ ] ConfigMap volume mounts\n\n### MCPToolConfig Integration\n- [ ] ToolConfigRef configuration propagation\n- [ ] Tool filtering rule validation\n- [ ] Tool renaming rule validation\n- [ ] Configuration hash calculation and updates\n- [ ] Multiple MCPServers referencing same ToolConfig\n\n### Update Scenarios\n- [ ] Configuration update handling\n- [ ] Rolling update behavior\n- [ ] Status updates during transitions\n\n### Error Conditions\n- [ ] Invalid configuration error responses\n- [ ] Missing dependency handling\n- [ ] Recovery from error states\n\n## Implementation Notes\n\nFollow existing test patterns from `mcp-registry/` tests, utilizing helper files and builder patterns for consistency and maintainability. Tests should be placed in `cmd/thv-operator/test-integration`.\n\n## Related Issues\n\n- Parent tracking issue: #3361","closed":false,"closedAt":null,"closedByPullRequestsReferences":[],"comments":[],"createdAt":"2026-01-20T20:56:34Z","id":"I_kwDOOHdoXs7knAUf","isPinned":false,"labels":[{"id":"LA_kwDOOHdoXs8AAAAB7bU01g","name":"enhancement","description":"New feature or request","color":"a2eeef"},{"id":"LA_kwDOOHdoXs8AAAAB9PXLvA","name":"kubernetes","description":"Items related to Kubernetes","color":"0000FF"},{"id":"LA_kwDOOHdoXs8AAAACNqqAVQ","name":"operator","description":"","color":"ededed"}],"milestone":null,"number":3363,"reactionGroups":[],"state":"OPEN","stateReason":"","title":"Integration tests: MCPServer edge cases and MCPToolConfig coverage","updatedAt":"2026-01-20T21:08:21Z","url":"https://github.com/stacklok/toolhive/issues/3363"},{"assignees":[],"author":{"id":"MDQ6VXNlcjI5NTQxNDg1","is_bot":false,"login":"ChrisJBurns","name":"Chris Burns"},"body":"## Overview\n\nAdd comprehensive integration tests for the MCPRemoteProxy Controller, which currently has zero test coverage.\n\n## Priority\n\n**Immediate** - This controller has no existing integration tests.\n\n## Test Scenarios to Implement\n\n### Basic Functionality\n- [x] Basic MCPRemoteProxy creation with OIDC config\n- [x] Deployment creation and validation\n- [x] Service creation and validation\n- [x] ConfigMap creation and validation\n\n### Integration with Other Resources\n- [ ] ExternalAuthConfigRef integration verification\n- [ ] ToolConfigRef configuration propagation\n- [ ] GroupRef membership validation\n\n### RBAC\n- [x] RBAC resource creation and management\n- [x] ServiceAccount handling\n\n### Status Conditions\n- [x] Ready condition tracking\n- [x] RemoteAvailable condition tracking\n- [x] AuthConfigured condition tracking\n- [x] Status updates on configuration changes\n\n### Lifecycle\n- [ ] Finalizer handling\n- [ ] Deletion cleanup\n- [ ] Update scenarios\n\n## Implementation Notes\n\nFollow existing test patterns from `mcp-registry/` tests, utilizing helper files and builder patterns for consistency and maintainability. Tests should be placed in `cmd/thv-operator/test-integration`.\n\n## Related Issues\n\n- Parent tracking issue: #3361","closed":false,"closedAt":null,"closedByPullRequestsReferences":[],"comments":[],"createdAt":"2026-01-20T20:49:33Z","id":"I_kwDOOHdoXs7km5Ye","isPinned":false,"labels":[{"id":"LA_kwDOOHdoXs8AAAAB7bU01g","name":"enhancement","description":"New feature or request","color":"a2eeef"},{"id":"LA_kwDOOHdoXs8AAAAB9PXLvA","name":"kubernetes","description":"Items related to Kubernetes","color":"0000FF"},{"id":"LA_kwDOOHdoXs8AAAACCmVMRg","name":"authentication","description":"","color":"ededed"},{"id":"LA_kwDOOHdoXs8AAAACCmVMRw","name":"proxy","description":"","color":"ededed"},{"id":"LA_kwDOOHdoXs8AAAACNqqAVQ","name":"operator","description":"","color":"ededed"}],"milestone":null,"number":3362,"reactionGroups":[],"state":"OPEN","stateReason":"","title":"Integration tests: MCPRemoteProxy Controller","updatedAt":"2026-01-21T15:53:10Z","url":"https://github.com/stacklok/toolhive/issues/3362"},{"assignees":[],"author":{"id":"MDQ6VXNlcjI5NTQxNDg1","is_bot":false,"login":"ChrisJBurns","name":"Chris Burns"},"body":"## Overview\n\nThis is a tracking issue for improving integration test coverage across the ToolHive Operator controllers. The goal is to address gaps identified in the integration test analysis and ensure comprehensive coverage for all operator controllers.\n\n## Background\n\nAn analysis of the current integration test coverage revealed significant gaps across several controllers. This initiative will systematically add tests to improve coverage and catch regressions.\n\n## Child Issues\n\n### Immediate Priority\n- [ ] #3362 - MCPRemoteProxy Controller integration tests\n\n### Medium Priority\n- [ ] #3363 - MCPServer edge cases and MCPToolConfig coverage\n\n## Implementation Guidelines\n\n- Follow existing test patterns from `mcp-registry/` tests\n- Utilize helper files and builder patterns for consistency\n- Tests should be placed in `test/e2e/chainsaw/operator/`\n- Each test should validate both happy path and error conditions\n- Include status condition verification in all tests","closed":false,"closedAt":null,"closedByPullRequestsReferences":[],"comments":[],"createdAt":"2026-01-20T20:49:03Z","id":"I_kwDOOHdoXs7km4_b","isPinned":false,"labels":[{"id":"LA_kwDOOHdoXs8AAAAB7bU01g","name":"enhancement","description":"New feature or request","color":"a2eeef"},{"id":"LA_kwDOOHdoXs8AAAAB9PXLvA","name":"kubernetes","description":"Items related to Kubernetes","color":"0000FF"},{"id":"LA_kwDOOHdoXs8AAAACNqqAVQ","name":"operator","description":"","color":"ededed"}],"milestone":null,"number":3361,"reactionGroups":[],"state":"OPEN","stateReason":"","title":"Operator integration test coverage improvements","updatedAt":"2026-01-20T20:57:26Z","url":"https://github.com/stacklok/toolhive/issues/3361"},{"assignees":[{"id":"MDQ6VXNlcjI1MzA4NjE=","login":"yrobla","name":"Yolanda Robla Mota","databaseId":0}],"author":{"id":"MDQ6VXNlcjEwNTMyMTgx","is_bot":false,"login":"jerm-dro","name":"Jeremy Drouillard"},"body":"# Summary\n\nThe ToolHive Kubernetes operator has admission webhook code for validating `VirtualMCPServer`, `VirtualMCPCompositeToolDefinition`, and `MCPExternalAuthConfig` resources, but these webhooks have never been functional. The controller-runtime v0.23.0 upgrade exposed this issue.\n\n## Background\n\n### What Happened\n\nDuring the upgrade to controller-runtime v0.23.0, the operator began failing at startup with:\n\n```\n\"error\":\"open /tmp/k8s-webhook-server/serving-certs/tls.crt: no such file or directory\"\n```\n\n### Root Cause Analysis\n\nInvestigation revealed that **the webhooks were never actually working**:\n\n1. **In controller-runtime v0.22.x**: The old webhook API (`ctrl.NewWebhookManagedBy(mgr).For(r).Complete()`) silently failed to register webhooks. The webhook server never started because no webhooks were registered with it.\n\n2. **In controller-runtime v0.23.0**: The new generic webhook API (`builder.WebhookManagedBy[T](mgr, r).WithValidator(r).Complete()`) properly registers webhooks, which triggers the webhook server to start, which then fails because TLS certificates are not available.\n\n### Missing Infrastructure\n\nEven if the webhook server started, the webhooks would not function because:\n\n| Component | Required | Status |\n|-----------|----------|--------|\n| ValidatingWebhookConfiguration | ✓ | Not deployed by helm chart |\n| Webhook Service | ✓ | Not deployed by helm chart |\n| Port 9443 exposed | ✓ | Not in deployment spec |\n| TLS certificates | ✓ | No cert-manager integration |\n\nThe `config/webhook/manifests.yaml` file exists (kubebuilder-generated) but is never deployed.\n\n## Impact of Missing Webhooks\n\nThe webhooks perform validation-only (no mutation). Without them:\n\n| Resource | Webhook Validation | Controller Validation | Risk |\n|----------|-------------------|----------------------|------|\n| VirtualMCPServer | Disabled | Partial (during reconcile) | Low - caught at reconcile |\n| MCPExternalAuthConfig | Disabled | None | **High - invalid configs silently accepted** |\n| VirtualMCPCompositeToolDefinition | Disabled | None | **High - invalid configs silently accepted** |\n\n### Example Validations Not Enforced\n\n**MCPExternalAuthConfig:**\n- Can create `tokenExchange` type without required `tokenExchange` config\n- Can set conflicting configs (both `tokenExchange` and `headerInjection`)\n- Unsupported auth types are accepted\n\n**VirtualMCPServer:**\n- Missing required `spec.config.groupRef` (caught at reconcile, but not at admission)\n- Invalid auth configurations\n\n## Proposed Solution\n\n### Option 1: Full Webhook Support (Recommended for Production)\n\n1. Add cert-manager as a dependency or optional integration\n2. Deploy ValidatingWebhookConfiguration via helm chart\n3. Create webhook Service in helm chart\n4. Expose port 9443 in deployment\n5. Configure cert-manager Certificate resource\n\n### Option 2: Self-Signed Certificates (Development/Simple Deployments)\n\n1. Generate self-signed certificates at operator startup\n2. Mount emptyDir volume for certificate storage\n3. Deploy ValidatingWebhookConfiguration with `caBundle` injection\n4. Create webhook Service\n\n### Option 3: Keep Webhooks Disabled (Current State)\n\n1. Document that webhooks are not functional\n2. Add controller-level validation for MCPExternalAuthConfig and VirtualMCPCompositeToolDefinition\n3. Accept that invalid resources can be created (will fail at runtime)\n\n## Current Workaround\n\nWebhook registration has been disabled in `cmd/thv-operator/main.go` to allow the operator to start. The webhook server is not created.\n\n\n## References\n\n- controller-runtime v0.23.0 breaking change: [Generic Validator and Defaulter](https://github.com/kubernetes-sigs/controller-runtime/releases/tag/v0.23.0)\n- Webhook manifest location: `config/webhook/manifests.yaml`\n- Affected files:\n  - `cmd/thv-operator/main.go`\n  - `cmd/thv-operator/api/v1alpha1/*_webhook.go`\n","closed":false,"closedAt":null,"closedByPullRequestsReferences":[],"comments":[],"createdAt":"2026-01-20T19:03:12Z","id":"I_kwDOOHdoXs7klgz6","isPinned":false,"labels":[{"id":"LA_kwDOOHdoXs8AAAAB7bU0xQ","name":"bug","description":"Something isn't working","color":"d73a4a"},{"id":"LA_kwDOOHdoXs8AAAACNqqAVQ","name":"operator","description":"","color":"ededed"},{"id":"LA_kwDOOHdoXs8AAAACQ-UOJw","name":"vmcp","description":"Virtual MCP Server related issues","color":"5319E7"}],"milestone":null,"number":3360,"reactionGroups":[],"state":"OPEN","stateReason":"","title":"[BUG] vmcp: Enable Admission Webhooks for Kubernetes Operator","updatedAt":"2026-01-22T13:51:47Z","url":"https://github.com/stacklok/toolhive/issues/3360"},{"assignees":[{"id":"MDQ6VXNlcjIxMTQ4NDIz","login":"carlos-gn","name":"Carlos","databaseId":0}],"author":{"id":"MDQ6VXNlcjY1OTk4MDM=","is_bot":false,"login":"eleftherias","name":"Eleftheria Stein-Kousathana"},"body":"Formalising this future enhancement into an issue\nhttps://github.com/stacklok/toolhive/blob/1f6ecc0bf645d55f9f32bf5f0341ce17b58fb6bc/docs/remote-mcp-authentication.md?plain=1#L434\n\n## Problem                                                                                                                                                                            \n                                                                                                                                                                                        \nWhen using Dynamic Client Registration (RFC 7591) for remote MCP servers, client credentials are not persisted across restarts. This causes:                                                          \n                                                                                                                                                                                        \n  1. New OAuth client registered on every `thv run` execution                                                                                                                           \n  2. Orphaned client registrations accumulate in OAuth providers                                                                                                                        \n  3. Risk of rate limiting from excessive registration requests                                                                                                                                                                                                                                            \n\n## Acceptance Criteria                                                                                                                                                                   \n                                                                                                                                                                                        \n  - DCR credentials (client_id, client_secret) persisted after registration                                                                                                             \n  - DCR metadata (client_secret_expires_at, registration_access_token) stored                                                                                                           \n  - Credentials reused across thv run restarts                                                                                                                                          \n  - Expired credentials trigger automatic re-registration                                                                                                                               \n  - thv secret list shows persisted DCR secrets                                                                                                                                         \n  - thv secret rm can remove persisted credentials                                                                                                                                      \n  - Backward compatibility maintained for existing configs                                                                                                                              \n  - Documentation updated                                                                                                                                                               \n                                                                                                                                                                                        \n## References                                                                                                                                                                                                                                     \n  - https://datatracker.ietf.org/doc/html/rfc7591     ","closed":false,"closedAt":null,"closedByPullRequestsReferences":[],"comments":[{"id":"IC_kwDOOHdoXs7hjyXP","author":{"login":"carlos-gn"},"authorAssociation":"CONTRIBUTOR","body":"@eleftherias actually this happened to me with the atlassian mcp. Assign it to me :)","createdAt":"2026-01-22T12:54:30Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"ROCKET","users":{"totalCount":1}}],"url":"https://github.com/stacklok/toolhive/issues/3335#issuecomment-3784254927","viewerDidAuthor":false}],"createdAt":"2026-01-19T10:10:37Z","id":"I_kwDOOHdoXs7kOXjr","isPinned":false,"labels":[{"id":"LA_kwDOOHdoXs8AAAAB7bU01g","name":"enhancement","description":"New feature or request","color":"a2eeef"},{"id":"LA_kwDOOHdoXs8AAAACCmVMRg","name":"authentication","description":"","color":"ededed"},{"id":"LA_kwDOOHdoXs8AAAACCmVMRw","name":"proxy","description":"","color":"ededed"},{"id":"LA_kwDOOHdoXs8AAAACJiuvqw","name":"cli","description":"Changes that impact CLI functionality","color":"0ed856"}],"milestone":null,"number":3335,"reactionGroups":[],"state":"OPEN","stateReason":"","title":"Persist dynamically registered OAuth clients across sessions","updatedAt":"2026-01-22T12:57:42Z","url":"https://github.com/stacklok/toolhive/issues/3335"},{"assignees":[{"id":"MDQ6VXNlcjE0NTU2NA==","login":"JAORMX","name":"Juan Antonio Osorio","databaseId":0}],"author":{"id":"MDQ6VXNlcjcxODM4NA==","is_bot":false,"login":"jpambrun","name":"Jean Francois Pambrun"},"body":"## Bug description\nI have Keyctl enable and working. I can list/get/set secrets. On reboot, on first get toolhive request the keyctl password again. If I mistype, all following invocation will fail. The only workaround I could find is to reboot.\n\n## Steps to reproduce\n```\n❯ toolhive secret get github\n5:18PM  INFO    Using keyring provider: Linux Keyctl\nToolHive needs a password to secure your credentials in the OS keyring.\nThis password will be used to encrypt and decrypt API tokens and other secrets\nthat need to be accessed by MCP servers. It will be securely stored in your OS keyring\nso you won't need to enter it each time.\nPlease enter your keyring password:\n5:18PM  INFO    writing password to Linux Keyctl\nError: failed to create secrets manager: failed to create secrets manager: unable to decrypt secrets file: cipher: message authentication failed\n\n~\n❯ toolhive secret get github\n5:18PM  INFO    Using keyring provider: Linux Keyctl\nError: failed to create secrets manager: failed to create secrets manager: unable to decrypt secrets file: cipher: message authentication failed\n```\n\n## Expected behavior\nI expect to have a second chance at typing my password.\n\n## Actual behavior\nI can't retry before rebooting.\n\n## Environment (if relevant)\n- OS/version: Linux under WSL\n- ToolHive version:  v0.7.1 73d4f262da88e290b9ce82683996cfdf838db432\n\n## Additional context\nAny additional information or logs you think might help.\n","closed":false,"closedAt":null,"closedByPullRequestsReferences":[{"id":"PR_kwDOOHdoXs698z7u","number":3334,"repository":{"id":"R_kgDOOHdoXg","name":"toolhive","owner":{"id":"O_kgDOBpIYMg","login":"stacklok"}},"url":"https://github.com/stacklok/toolhive/pull/3334"}],"comments":[{"id":"IC_kwDOOHdoXs7giGDr","author":{"login":"JAORMX"},"authorAssociation":"MEMBER","body":"Thanks for reporting this. We've identified the root cause and are working on a fix.\n\n**Workaround:** Run `thv secret reset-keyring` to clear the cached password, then retry with the correct password.","createdAt":"2026-01-19T08:20:20Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/stacklok/toolhive/issues/3332#issuecomment-3767034091","viewerDidAuthor":false},{"id":"IC_kwDOOHdoXs7gkR_o","author":{"login":"JAORMX"},"authorAssociation":"MEMBER","body":"Got a fix ready, it should be included in the next toolhive release. At least it's in `main` now.","createdAt":"2026-01-19T10:32:29Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/stacklok/toolhive/issues/3332#issuecomment-3767607272","viewerDidAuthor":false}],"createdAt":"2026-01-18T22:24:03Z","id":"I_kwDOOHdoXs7kIZva","isPinned":false,"labels":[{"id":"LA_kwDOOHdoXs8AAAAB7bU0xQ","name":"bug","description":"Something isn't working","color":"d73a4a"},{"id":"LA_kwDOOHdoXs8AAAACCmVMRg","name":"authentication","description":"","color":"ededed"},{"id":"LA_kwDOOHdoXs8AAAACJiuvqw","name":"cli","description":"Changes that impact CLI functionality","color":"0ed856"}],"milestone":null,"number":3332,"reactionGroups":[],"state":"OPEN","stateReason":"REOPENED","title":"toolhive with Keyctl won't ask password again if first mistaken","updatedAt":"2026-01-19T10:32:29Z","url":"https://github.com/stacklok/toolhive/issues/3332"},{"assignees":[],"author":{"id":"MDQ6VXNlcjcxODM4NA==","is_bot":false,"login":"jpambrun","name":"Jean Francois Pambrun"},"body":"## Bug description\nI am trying this for the first time; I trying to connect to atlassian-remote just to get started.\nI have the linux keyctl setup and can add/list/get secrets.\n\nstating \n```\n> toolhive start atlassian-remote\n4:49PM  INFO    Loaded configuration from state for atlassian-remote\n4:49PM  INFO    Starting tooling server atlassian-remote...\n4:49PM  INFO    Logging to: /home/jpambrun/.local/share/toolhive/logs/atlassian-remote.log\n4:49PM  INFO    MCP server is running in the background (PID: 4120044)\n4:49PM  INFO    Use 'thv stop atlassian-remote' to stop the server\n```\nbut it doesn't work, the logs indicate the issue\n```\n4:52PM  INFO    Starting OAuth authentication flow for issuer: https://cf.mcp.atlassian.com\n4:52PM  INFO    Successfully registered OAuth client dynamically - client_id: nG58...\n4:52PM  INFO    Using OAuth endpoints - authorize_url: https://mcp.atlassian.com/v1/authorize, token_url: https://cf.mcp.atlassian.com/v1/token\n4:52PM  INFO    Opening browser to: https://mcp.atlassian.com/v1/authorize?client_id=nG58rBQ_SHP1FKbf&code_challenge=Ryo...&code_challenge_method=S256&redirect_uri=http%3A%2F%2Flocalhost%3A8666%2Fcallback&response_type=code&scope=openid+profile&state=3ELw..\n```\nI only have 30s to start, cat the logs and go through the flow. This isn't amazing, but it works. \n\nHowever, I expected to see some new secrets with `toolhive secret list`, but didn't see any. Restarting the Atlassian mcp I am presented with the same logs requesting another oauth flow.\n\nAm I missing something? \n\n## Steps to reproduce\nProvide steps or commands needed to reproduce the issue.\n1. toolhive start atlassian-remote\n2. cat logs, and go through the flow\n3. toolhive stop atlassian-remote\n4. toolhive start atlassian-remote\n5. [not authenticated]\n\n## Expected behavior\n1. toolhive start atlassian-remote should present me with the oauth login url\n2. I expect some sort of secret to be persisted and being able to restart the mcp server without having to go through the flow again.\n\n## Actual behavior\nNo persistence \n\n## Environment (if relevant)\n- OS/version: linux under WSL\n- ToolHive version: v0.7.1 (73d4f262da88e290b9ce82683996cfdf838db432)\n\n## Additional context\nAny additional information or logs you think might help.\n","closed":false,"closedAt":null,"closedByPullRequestsReferences":[{"id":"PR_kwDOOHdoXs6-hw_k","number":3382,"repository":{"id":"R_kgDOOHdoXg","name":"toolhive","owner":{"id":"O_kgDOBpIYMg","login":"stacklok"}},"url":"https://github.com/stacklok/toolhive/pull/3382"}],"comments":[{"id":"IC_kwDOOHdoXs7ginUy","author":{"login":"eleftherias"},"authorAssociation":"MEMBER","body":"Hey @jpambrun, it looks like you're having 2 issues:\n\n**1. The OAuth flow is not starting automatically, so you need to find the login URL in the logs**\n\nBy default ToolHive will try to open your browser to initiate the OAuth flow. It's likely your environment is blocking this behaviour. ToolHive should detect this and print a log message with the login URL, but it's not doing that, which is a bug. I will look into why it's not printing the login URL.\n\n**2. The OAuth credentials aren't persisted between restarts**\n\nIn the case of the atlassian-remote server ToolHive is using [dynamic client registration](https://modelcontextprotocol.io/specification/2025-06-18/basic/authorization#dynamic-client-registration) to create the client ID and secret. These are not persisted in the secret store and are regenerated on every new run. It's on our TODO list to persist the dynamic credentials.\nIf you had static credentials, like this:\n```\nthv run atlassian-remote --remote-auth-client-id <ID> --remote-auth-client-secret <secret>\n```\nthen they would be persisted in the secret store and you would see them when running `thv secret list`.\n\nHowever, in both cases the login flow is re-initiated to get a fresh token when the server restarts. ToolHive doesn't persist the tokens between server restarts, only the client ID and secret. If this is something that's causing friction, we can definitely revisit it.","createdAt":"2026-01-19T08:55:21Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/stacklok/toolhive/issues/3331#issuecomment-3767170354","viewerDidAuthor":false}],"createdAt":"2026-01-18T22:03:47Z","id":"I_kwDOOHdoXs7kIUsF","isPinned":false,"labels":[{"id":"LA_kwDOOHdoXs8AAAAB7bU0xQ","name":"bug","description":"Something isn't working","color":"d73a4a"},{"id":"LA_kwDOOHdoXs8AAAACCmVMRg","name":"authentication","description":"","color":"ededed"},{"id":"LA_kwDOOHdoXs8AAAACHd-1gA","name":"registry","description":"","color":"ededed"},{"id":"LA_kwDOOHdoXs8AAAACJiuvqw","name":"cli","description":"Changes that impact CLI functionality","color":"0ed856"}],"milestone":null,"number":3331,"reactionGroups":[],"state":"OPEN","stateReason":"","title":"Oauth flow persistence and usability","updatedAt":"2026-01-19T08:55:21Z","url":"https://github.com/stacklok/toolhive/issues/3331"},{"assignees":[{"id":"MDQ6VXNlcjM0MTEzODQ0","login":"olamide226","name":"Ola Adebayo","databaseId":0}],"author":{"id":"MDQ6VXNlcjM0MTEzODQ0","is_bot":false,"login":"olamide226","name":"Ola Adebayo"},"body":"## Bug Description\n\nWhen manually scaling a StatefulSet replicas (e.g., increasing from 1 to 3), the ToolHive operator automatically reverts the replica count back to 1. This behavior prevents horizontal scaling of MCP servers.\n\n## Steps to Reproduce\n\n1. Deploy an MCP server via the ToolHive operator (creates a StatefulSet with 1 replica)\n2. Manually scale the StatefulSet:\n   ```bash\n   kubectl scale statefulset <mcpserver-name> --replicas=3\n   ```\n3. Observe that the operator reverts the replicas back to 1\n\n## Expected Behavior\n\nThe operator should NOT automatically revert manual scaling changes. The manually set replica count should persist.\n\n## Actual Behavior\n\nThe operator overrides the manual scaling and resets replicas to 1.\n\n## Root Cause\n\nThe MCPServer CRD lacks a `replicas` field to persist the desired replica state. Without this field, the operator has no way to know whether the replica count was intentionally changed, causing it to revert to its default state.\n\n## Proposed Solution\n\n1. Add a `replicas` field to the MCPServer CRD spec to allow users to declare the desired replica count\n2. Update the operator to respect this field and not override manual scaling changes\n3. The field should be optional with a default value of 1 for backward compatibility\n\nExample:\n```yaml\napiVersion: toolhive.stacklok.dev/v1alpha1\nkind: MCPServer\nmetadata:\n  name: my-mcp-server\nspec:\n  replicas: 3  # New field\n  image: my-image:latest\n  # ... other fields\n```\n\n## Additional Context\n\n- For scaling purposes, typically only one proxy/runner is needed since it routes to a headless service and can load balance between pods in the StatefulSet\n- This is especially relevant for stateless MCP servers or Streamable HTTP MCP servers where load balancing works well\n- For stateful MCP servers, scaling considerations may be more complex\n\n## Environment\n\n- ToolHive Operator version: v0.6.12\n- Kubernetes version: v1.33.3+k3s1\n\n---\n\nRelated discussion: The community has confirmed this is a bug and the operator should NOT revert manual scaling changes.","closed":false,"closedAt":null,"closedByPullRequestsReferences":[],"comments":[{"id":"IC_kwDOOHdoXs7g_GIa","author":{"login":"ChrisJBurns"},"authorAssociation":"MEMBER","body":"Hey @olamide226 thanks for the issue. You're completely correct in that we don't support scaling at the moment via increasing replica count. This is just down to some of the trickiness behind the scenes with the different transport types. For example, in the Streamable HTTP case scaling is a bit easier and we just have to do some logic in the proxy to ensure it knows where to route requests and responses. But stdio is tricky because its very nature its a constant 1:1 connection. This means that you'd have to have a proxy for each MCP StatefulSet in order to work. Otherwise if you have the issue with responses being returned to the wrong users - unless of course you have a bunch of complexity in the proxyrunner. Either way its quite a big technical task architecturally at the moment which we're constantly discussing internally within the project - so stay tuned!","createdAt":"2026-01-20T19:43:54Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/stacklok/toolhive/issues/3329#issuecomment-3774636570","viewerDidAuthor":false},{"id":"IC_kwDOOHdoXs7hiVl0","author":{"login":"olamide226"},"authorAssociation":"CONTRIBUTOR","body":"@ChrisJBurns understood. The original reason for this BUG was because we wanted to scale down to ZERO to temporarily stop the server.  how do you suggest we stop an MCPServer for the aim of starting it again(without deleting the resource)? maybe some `spec.Suspend` attribute added to the proxy runner?","createdAt":"2026-01-22T11:22:02Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/stacklok/toolhive/issues/3329#issuecomment-3783874932","viewerDidAuthor":false},{"id":"IC_kwDOOHdoXs7hj8WA","author":{"login":"olamide226"},"authorAssociation":"CONTRIBUTOR","body":"@ChrisJBurns  @JAORMX After giving it some thought, given the current architecture (operator owns the proxy Deployment; proxyrunner owns the backend StatefulSet), the cleanest transport‑agnostic stop/start/restart is to make the operator the source of truth for backend lifecycle, not just the proxy.\n\nTwo viable paths:\n\n  1) Minimal change (works with existing architecture)\n\n  - Stop: add spec.suspend (or spec.desiredState: Stopped) to MCPServer. In reconcile, if suspended:\n      - scale proxy Deployment to 0\n      - delete the backend StatefulSet + headless service (same logic you already have in finalizer)\n  - Start: set spec.suspend=false; operator scales proxy Deployment back to 1, proxyrunner\n    recreates the StatefulSet.\n  - Restart: keep the current restart annotation on the CR, but update the proxyrunner to force a backend restart by:\n      - deleting the StatefulSet pods (or bumping a pod‑template annotation on the StatefulSet) in the proxyrunner’s apply step,   and\n      - still rolling the proxy so it re‑applies the updated StatefulSet.\n\nThis keeps transport agnostic and avoids scaling complexities.\n\n  2) Structural change (cleanest long‑term)\n\n  - Move backend StatefulSet creation into the operator (controller‑runtime), and make proxyrunner\n    JUST a proxy process.\n  - Then spec.suspend, spec.restartAt, etc. are all enforced directly by the operator against the\n    StatefulSet, and we're no longer fighting a second reconciler (proxyrunner) that re‑applies\n    replicas=1.\n\n  Right now, manual scaling down(replica=0) gets “reset to 1” because proxyrunner’s k8s runtime applies the\n  StatefulSet with replicas=1 on startup. That will continue unless we introduce a true lifecycle\n  signal (like spec.suspend) that proxyrunner honors or until we move that workload management into the\n  operator territory.","createdAt":"2026-01-22T13:02:30Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/stacklok/toolhive/issues/3329#issuecomment-3784295808","viewerDidAuthor":false}],"createdAt":"2026-01-17T23:36:40Z","id":"I_kwDOOHdoXs7kDJ1b","isPinned":false,"labels":[{"id":"LA_kwDOOHdoXs8AAAAB7bU0xQ","name":"bug","description":"Something isn't working","color":"d73a4a"},{"id":"LA_kwDOOHdoXs8AAAAB9PXLvA","name":"kubernetes","description":"Items related to Kubernetes","color":"0000FF"},{"id":"LA_kwDOOHdoXs8AAAACNqqAVQ","name":"operator","description":"","color":"ededed"}],"milestone":null,"number":3329,"reactionGroups":[],"state":"OPEN","stateReason":"","title":"[BUG] Operator reverts manual StatefulSet replica scaling back to 1","updatedAt":"2026-01-22T13:02:30Z","url":"https://github.com/stacklok/toolhive/issues/3329"},{"assignees":[{"id":"MDQ6VXNlcjY4MjU5Mw==","login":"tgrunnagle","name":"Trey","databaseId":0},{"id":"MDQ6VXNlcjcxNTUyMg==","login":"jhrozek","name":"Jakub Hrozek","databaseId":0}],"author":{"id":"MDQ6VXNlcjkzNjExMjI=","is_bot":false,"login":"Derek2Tu","name":""},"body":"**Description:**\n\nCurrently, ToolHive passes through certain headers to MCP servers as a side effect of not stripping them, rather than through intentional configuration. We should implement explicit support for specifying additional headers to forward to MCP servers.\n\n**Requirements:**\n- Add configuration option to define a list of headers that should be passed through to MCP servers\n- Support this functionality in both local and Kubernetes deployment modes\n- Make header passthrough behavior intentional and documented rather than incidental\n","closed":false,"closedAt":null,"closedByPullRequestsReferences":[],"comments":[{"id":"IC_kwDOOHdoXs7gCiwg","author":{"login":"jhrozek"},"authorAssociation":"MEMBER","body":"@tgrunnagle @glageju do we have more details on this?","createdAt":"2026-01-16T08:32:38Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/stacklok/toolhive/issues/3316#issuecomment-3758763040","viewerDidAuthor":false},{"id":"IC_kwDOOHdoXs7gKoRX","author":{"login":"tgrunnagle"},"authorAssociation":"MEMBER","body":"I think this refers to the cloud_id header for Atlassian - if so the existing header pass-through from the client supports it. @Derek2Tu can you confirm? ","createdAt":"2026-01-16T16:38:39Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/stacklok/toolhive/issues/3316#issuecomment-3760882775","viewerDidAuthor":false}],"createdAt":"2026-01-15T23:38:50Z","id":"I_kwDOOHdoXs7jqyBX","isPinned":false,"labels":[{"id":"LA_kwDOOHdoXs8AAAAB7bU01g","name":"enhancement","description":"New feature or request","color":"a2eeef"},{"id":"LA_kwDOOHdoXs8AAAAB828HLQ","name":"go","description":"Pull requests that update go code","color":"16e2e2"}],"milestone":null,"number":3316,"reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":2}}],"state":"OPEN","stateReason":"","title":"[FEATURE] Support configurable header passthrough for MCP server requests","updatedAt":"2026-01-20T15:50:33Z","url":"https://github.com/stacklok/toolhive/issues/3316"},{"assignees":[],"author":{"id":"MDQ6VXNlcjY5MjI1MTU=","is_bot":false,"login":"danbarr","name":"Dan Barr"},"body":"## Summary\n\nThe `proxyMode` configuration field (CLI `--proxy-mode`, API/CRD `proxyMode`) causes user confusion and has led to bugs in workload discovery across vMCP, Optimizer, and UI (Playground). The field's name and behavior don't match, requiring clients to implement complex logic to determine the actual protocol in use.\n\n## Problem Statement\n\n### Current Behavior (Validated)\n\n1. **proxyMode is ONLY intended for `transport=stdio`**\n   - Purpose: Tells the stdio transport which HTTP proxy protocol to use (sse or streamable-http)\n   - Documented in: `pkg/runner/config.go:149-151`, `cmd/thv-operator/api/v1alpha1/mcpserver_types.go:61-66`\n\n2. **proxyMode can be set on non-stdio transports, but has no effect**\n   - CLI, CRD, and API accept proxyMode on any transport type\n   - Non-stdio transports (sse, streamable-http) completely ignore the setting\n   - Code: `pkg/transport/factory.go:51` - only stdio transport receives proxyMode\n\n3. **The stored proxyMode value is only meaningful if `transport=stdio`**\n   - For stdio: proxyMode indicates the actual HTTP protocol\n   - For sse/streamable-http: proxyMode may be empty, set incorrectly, or misleading\n\n4. **proxyMode has inconsistent defaults and may be absent**\n   - Most of codebase defaults to `streamable-http`\n   - **CONFLICT**: `pkg/transport/stdio.go:124` defaults to `sse` for \"backward compatibility\"\n   - Field is optional, requiring defensive checks when reading\n\n### Client Logic Required\n\nClients (vMCP, Optimizer, UI) must implement this logic to determine the actual protocol:\n\n```\nIF transport == stdio THEN\n    use proxyMode (or default to streamable-http)\nELSE\n    use transport type as the protocol\n```\n\nThis logic is implemented in `GetEffectiveProxyMode()` in `pkg/workloads/types/types.go:114-125`, but every client must know to use it.\n\n## Root Causes of Confusion\n\n### 1. Misleading Name\n\"proxyMode\" suggests it controls how the proxy operates, but it actually means \"HTTP protocol for stdio transports only\". The name doesn't reflect its limited scope.\n\n### 2. Input Accepts Invalid Combinations\nUsers can configure `transport=sse, proxyMode=streamable-http` without any warning that proxyMode is being ignored.\n\n### 3. Conflicting Defaults\n- Most defaults: `streamable-http` (CLI, CRD, API, URL generation)\n- StdioTransport internal default: `sse` (stdio.go:124)\n\nThis creates undefined behavior when proxyMode is not explicitly set.\n\n### 4. Effective vs. Stored Values\nWhen reading a workload with `transport=sse`, the stored `proxyMode` might say something completely different, because it's only meaningful for stdio.\n\n## Impact\n\n- **User Confusion**: Discord/GitHub questions about when to use proxyMode\n- **Discovery Bugs**: vMCP, Optimizer, and UI (Playground) must implement client-side logic to determine actual protocol\n- **API Inconsistency**: Returned data doesn't directly represent the running configuration\n- **Maintenance Burden**: Every new client must understand and implement the effective-mode calculation\n\n## Proposed Solution\n\n**Make `proxyMode` always reflect the actual HTTP protocol the proxy is using.**\n\n### Semantics Change\n\n**Current (confusing):**\n```yaml\n# stdio workload\ntransport: stdio\nproxyMode: streamable-http  # Meaningful input: tells proxy which protocol to use\n\n# sse workload\ntransport: sse\nproxyMode: \"\"  # Empty, ignored, or misleading\n\n# Client must calculate: if stdio then use proxyMode else use transport\n```\n\n**Proposed (clear):**\n```yaml\n# stdio workload\ntransport: stdio\nproxyMode: streamable-http  # The actual protocol in use\n\n# sse workload\ntransport: sse\nproxyMode: sse  # ALWAYS populated with actual protocol\n\n# streamable-http workload\ntransport: streamable-http\nproxyMode: streamable-http  # ALWAYS matches reality\n\n# Clients can always use proxyMode - it's the source of truth\n```\n\n### Benefits\n\n1. **Clear semantics**: `proxyMode` = \"what HTTP protocol is this workload actually using?\"\n2. **No client logic**: Clients can use `proxyMode` directly without conditional logic\n3. **Consistent representation**: Same meaning across API responses, CRD status, workload listings\n4. **Name matches behavior**: \"proxy mode\" actually reflects the mode the proxy is operating in\n\n### Implementation Strategy\n\n1. **Normalize at API boundaries**: When returning workloads (API responses, CRD status), always populate `proxyMode` using `GetEffectiveProxyMode()`\n2. **Keep backward compatibility**: Input still allows empty proxyMode for stdio, but output always populates it\n3. **Update documentation**: Clarify that proxyMode is always the effective protocol\n4. **Optional: Deprecation path**: Consider renaming in a future major version to `protocol` or `proxyProtocol`\n\n## Implementation Considerations\n\n### Breaking Changes?\n- **API responses**: proxyMode will always be populated (previously could be empty)\n- **CRD status**: Same as API\n- **Backward compatibility**: Old configs without proxyMode still work (normalized on read)\n\n### Migration\n- Existing workloads: No migration needed - normalization happens at read time\n- Client code: Clients can simplify by removing conditional logic\n\n### Code Changes Needed\n1. Normalize proxyMode in API handlers when returning workload data\n2. Populate proxyMode in CRD status\n3. Update vMCP backend discovery to use proxyMode directly\n4. Update Optimizer to use proxyMode directly\n5. Update UI/Playground to use proxyMode directly\n6. Fix conflicting default in `pkg/transport/stdio.go:124` (sse → streamable-http)\n7. Consider validation warning when user sets proxyMode on non-stdio transports\n\n## References\n\n### Key Code Locations\n\n**Definition:**\n- `pkg/runner/config.go:149-151` - ProxyMode in RunConfig\n- `pkg/transport/types/transport.go:239-249` - ProxyMode type\n\n**Setting:**\n- `cmd/thv/app/run_flags.go:129-132` - CLI flag\n- `cmd/thv-operator/api/v1alpha1/mcpserver_types.go:61-66` - CRD field\n- `pkg/api/v1/workload_types.go:59` - API field\n\n**Usage:**\n- `pkg/transport/factory.go:51` - Only passed to stdio transport\n- `pkg/transport/stdio.go:181-202` - Stdio switches on proxyMode\n- `pkg/workloads/types/types.go:114-125` - GetEffectiveProxyMode calculates actual protocol\n- `pkg/vmcp/workloads/k8s.go:197` - vMCP uses effective mode\n\n**Defaults:**\n- `pkg/transport/stdio.go:124` - ⚠️ Defaults to SSE (conflicts with everything else)\n- `cmd/thv/app/run_flags.go:131` - Defaults to streamable-http\n- `cmd/thv-operator/api/v1alpha1/mcpserver_types.go:64` - Defaults to streamable-http\n- `pkg/api/v1/workload_service.go:116` - Defaults to streamable-http\n\n### Test Coverage\n- `pkg/workloads/types/effective_transport_test.go` - Tests GetEffectiveProxyMode\n- `pkg/transport/url_test.go` - Tests URL generation with proxyMode\n\n## Recommendation\n\nImplement the proposed solution to:\n1. Eliminate user confusion about when/how to use proxyMode\n2. Simplify client code in vMCP, Optimizer, and UI\n3. Make the data model match the actual runtime behavior\n4. Fix the conflicting default in stdio.go:124","closed":false,"closedAt":null,"closedByPullRequestsReferences":[],"comments":[{"id":"IC_kwDOOHdoXs7fnzn4","author":{"login":"danbarr"},"authorAssociation":"MEMBER","body":"To reproduce points 2 & 3:\n\n```bash\nthv run fetch --proxy-mode sse\n```\n\nFetch is a `streamable-http` server (defined in the registry). The resulting runconfig contains:\n\n```json\n{\n  \"transport\": \"streamable-http\",\n# ...\n  \"proxy_mode\": \"sse\",\n}\n```\n\nBut here, `proxy_mode` is both ineffective and misleading. The actual proxy is in streamable-http mode.\n\n```bash\nthv mcp list tools --transport sse --server fetch\n# Error: failed to start MCP transport: unexpected status code: 405\n\nthv mcp list tools --transport streamable-http --server fetch\n# Succeeds, tools are listed\n```","createdAt":"2026-01-14T21:17:07Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/stacklok/toolhive/issues/3296#issuecomment-3751754232","viewerDidAuthor":false},{"id":"IC_kwDOOHdoXs7f6tKP","author":{"login":"Sanskarzz"},"authorAssociation":"CONTRIBUTOR","body":"@aponcedeleonch \nCan you please assign me this issue.","createdAt":"2026-01-15T20:22:09Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/stacklok/toolhive/issues/3296#issuecomment-3756708495","viewerDidAuthor":false},{"id":"IC_kwDOOHdoXs7f7Wjj","author":{"login":"danbarr"},"authorAssociation":"MEMBER","body":"Hi @Sanskarzz thanks for your interest. We're having some discussions around how this will be approached, which might not reflect the proposal in the issue. Once we have a path forward we'll update this.","createdAt":"2026-01-15T21:10:40Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/stacklok/toolhive/issues/3296#issuecomment-3756878051","viewerDidAuthor":false},{"id":"IC_kwDOOHdoXs7f7imJ","author":{"login":"Sanskarzz"},"authorAssociation":"CONTRIBUTOR","body":"Hi @danbarr \nThat will be super helpful. Thanks ","createdAt":"2026-01-15T21:22:36Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/stacklok/toolhive/issues/3296#issuecomment-3756927369","viewerDidAuthor":false}],"createdAt":"2026-01-14T20:46:08Z","id":"I_kwDOOHdoXs7jYWAq","isPinned":false,"labels":[{"id":"LA_kwDOOHdoXs8AAAAB7bU01g","name":"enhancement","description":"New feature or request","color":"a2eeef"},{"id":"LA_kwDOOHdoXs8AAAAB828HLQ","name":"go","description":"Pull requests that update go code","color":"16e2e2"},{"id":"LA_kwDOOHdoXs8AAAACCmVMRw","name":"proxy","description":"","color":"ededed"},{"id":"LA_kwDOOHdoXs8AAAACJiuvqw","name":"cli","description":"Changes that impact CLI functionality","color":"0ed856"},{"id":"LA_kwDOOHdoXs8AAAACJiu1Bw","name":"api","description":"Items related to the API","color":"b404c2"},{"id":"LA_kwDOOHdoXs8AAAACNqqAVQ","name":"operator","description":"","color":"ededed"}],"milestone":null,"number":3296,"reactionGroups":[{"content":"HEART","users":{"totalCount":2}}],"state":"OPEN","stateReason":"","title":"proxyMode configuration is confusing and inconsistent","updatedAt":"2026-01-15T21:22:36Z","url":"https://github.com/stacklok/toolhive/issues/3296"},{"assignees":[{"id":"MDQ6VXNlcjY4NjYwOTM=","login":"dmjb","name":"Don Browne","databaseId":0}],"author":{"id":"MDQ6VXNlcjY4NjYwOTM=","is_bot":false,"login":"dmjb","name":"Don Browne"},"body":"At the moment, our e2e suite excercises the CLI, and the k8s operator. It does not test the HTTP API, which sometimes results in bugs slipping through.\n\nImplement a set of e2e tests for the HTTP which provide equivalent coverage as for the CLI. Run them as a parallel task in the builds.","closed":false,"closedAt":null,"closedByPullRequestsReferences":[],"comments":[],"createdAt":"2026-01-14T11:59:25Z","id":"I_kwDOOHdoXs7jREXA","isPinned":false,"labels":[{"id":"LA_kwDOOHdoXs8AAAAB7bU01g","name":"enhancement","description":"New feature or request","color":"a2eeef"},{"id":"LA_kwDOOHdoXs8AAAACJiu1Bw","name":"api","description":"Items related to the API","color":"b404c2"}],"milestone":null,"number":3286,"reactionGroups":[],"state":"OPEN","stateReason":"","title":"Add E2E tests for the HTTP API","updatedAt":"2026-01-14T12:00:20Z","url":"https://github.com/stacklok/toolhive/issues/3286"},{"assignees":[],"author":{"id":"MDQ6VXNlcjY4NjYwOTM=","is_bot":false,"login":"dmjb","name":"Don Browne"},"body":"In #2872 I added healtchecks for remote workloads. We have since received reports that the healthchecks are marking workloads as unhealthy due to single ping failures.\n\nI am considering two approaches:\n\n1) Make the pings optional for remote workloads.\n2) Allow a number of pings to fail before marking the workload unhealthy.","closed":false,"closedAt":null,"closedByPullRequestsReferences":[],"comments":[],"createdAt":"2026-01-14T09:20:24Z","id":"I_kwDOOHdoXs7jO0CP","isPinned":false,"labels":[{"id":"LA_kwDOOHdoXs8AAAAB7bU01g","name":"enhancement","description":"New feature or request","color":"a2eeef"},{"id":"LA_kwDOOHdoXs8AAAACCmVMRw","name":"proxy","description":"","color":"ededed"}],"milestone":null,"number":3283,"reactionGroups":[],"state":"OPEN","stateReason":"","title":"Make healthchecks optional for remote workloads","updatedAt":"2026-01-14T09:21:26Z","url":"https://github.com/stacklok/toolhive/issues/3283"},{"assignees":[{"id":"MDQ6VXNlcjQ4NDU3MDM4","login":"lujunsan","name":"Luis Juncal","databaseId":0}],"author":{"id":"MDQ6VXNlcjQ4NDU3MDM4","is_bot":false,"login":"lujunsan","name":"Luis Juncal"},"body":"Intermittent context deadline exceeded errors are observed when Toolhive release binaries attempt to call update-service endpoints (e.g. update checks and usage metrics submission), while direct API calls and locally built binaries often succeed. The failures appear sporadic, client-specific, and not tied to request volume or payload size, and may affect both CLI and UI update-related flows. Investigation is needed to reliably reproduce the issue, determine scope and impact, and identify the underlying cause.","closed":false,"closedAt":null,"closedByPullRequestsReferences":[],"comments":[],"createdAt":"2026-01-13T02:45:45Z","id":"I_kwDOOHdoXs7i54-3","isPinned":false,"labels":[{"id":"LA_kwDOOHdoXs8AAAAB7bU0xQ","name":"bug","description":"Something isn't working","color":"d73a4a"},{"id":"LA_kwDOOHdoXs8AAAACJiuvqw","name":"cli","description":"Changes that impact CLI functionality","color":"0ed856"},{"id":"LA_kwDOOHdoXs8AAAACJiu1Bw","name":"api","description":"Items related to the API","color":"b404c2"},{"id":"LA_kwDOOHdoXs8AAAACLpzsvg","name":"telemetry","description":"","color":"aaaaaa"}],"milestone":null,"number":3270,"reactionGroups":[],"state":"OPEN","stateReason":"","title":"[BUG] Investigate intermittent client-side timeouts when calling update-service APIs","updatedAt":"2026-01-13T02:46:47Z","url":"https://github.com/stacklok/toolhive/issues/3270"},{"assignees":[{"id":"U_kgDOBYhI4w","login":"Sanskarzz","name":"Sanskar Gurdasani","databaseId":0}],"author":{"id":"MDQ6VXNlcjc4OTA4NTM=","is_bot":false,"login":"aponcedeleonch","name":"Alejandro Ponce de Leon"},"body":"## Bug description\n\nThe `/api/v1beta/workloads` endpoint incorrectly reports the transport type for workloads, while querying individual workloads via `/api/v1beta/workloads/{name}` returns the correct transport type.\n\n## Steps to reproduce\n\n1. Deploy a workload with stdio transport (e.g., the time MCP server)\n2. List all workloads: `curl http://localhost:8080/api/v1beta/workloads | jq`\n3. Query the specific workload: `curl http://localhost:8080/api/v1beta/workloads/time | jq`\n\n## Expected behavior\n\nBoth endpoints should report the same transport type. Since the container has MCP_TRANSPORT: stdio environment variable, the transport type should be stdio in both responses.\n\n## Actual behavior\n\nThe list endpoint shows `\"transport_type\": \"streamable-http\"`:\n```json\n{\n  \"name\": \"time\",\n  \"package\": \"docker.io/mcp/time:latest\",\n  \"url\": \"http://127.0.0.1:10618/mcp\",\n  \"port\": 10618,\n  \"transport_type\": \"streamable-http\",\n  \"proxy_mode\": \"streamable-http\",\n  \"status\": \"running\",\n  ...\n}\n```\n\nThe individual workload endpoint correctly shows `\"transport\": \"stdio\"`:\n```json\n{\n  \"image\": \"docker.io/mcp/time:latest\",\n  ...\n  \"env_vars\": {\n    \"MCP_TRANSPORT\": \"stdio\"\n  },\n  \"transport\": \"stdio\",\n  \"proxy_mode\": \"streamable-http\",\n  ...\n}\n```\n\n## Environment (if relevant)\n\n```bash\n% thv version\nToolHive v0.6.15\nCommit: d390486ff968e9a2c0b79d5aca9112144e228b69\nBuilt: 2025-12-17 19:58:30 UTC\nGo version: go1.25.5\nPlatform: darwin/arm64\n```\n\n## Additional context\nAny additional information or logs you think might help.\n","closed":false,"closedAt":null,"closedByPullRequestsReferences":[],"comments":[{"id":"IC_kwDOOHdoXs7dfeGa","author":{"login":"Sanskarzz"},"authorAssociation":"CONTRIBUTOR","body":"/assign","createdAt":"2026-01-06T19:27:53Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/stacklok/toolhive/issues/3178#issuecomment-3716014490","viewerDidAuthor":false},{"id":"IC_kwDOOHdoXs7dmIr_","author":{"login":"aponcedeleonch"},"authorAssociation":"MEMBER","body":"@Sanskarzz I assume you're volunteering to solve this issue, thanks a lot for the help! Will assign the issue to you but please feel free to un-assign yourself","createdAt":"2026-01-07T08:12:02Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/stacklok/toolhive/issues/3178#issuecomment-3717761791","viewerDidAuthor":true},{"id":"IC_kwDOOHdoXs7dwMCr","author":{"login":"Sanskarzz"},"authorAssociation":"CONTRIBUTOR","body":"@aponcedeleonch  Yes, your assumption is correct. I’m happy to contribute to this project. Thanks for assigning me the issue!","createdAt":"2026-01-07T19:19:50Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/stacklok/toolhive/issues/3178#issuecomment-3720396971","viewerDidAuthor":false}],"createdAt":"2026-01-02T11:42:02Z","id":"I_kwDOOHdoXs7hFC5n","isPinned":false,"labels":[{"id":"LA_kwDOOHdoXs8AAAAB7bU0xQ","name":"bug","description":"Something isn't working","color":"d73a4a"},{"id":"LA_kwDOOHdoXs8AAAAB7bU02w","name":"good first issue","description":"Good for newcomers","color":"7057ff"},{"id":"LA_kwDOOHdoXs8AAAACJiu1Bw","name":"api","description":"Items related to the API","color":"b404c2"}],"milestone":null,"number":3178,"reactionGroups":[],"state":"OPEN","stateReason":"","title":"List workloads API endpoint shows incorrect transport type","updatedAt":"2026-01-07T19:19:50Z","url":"https://github.com/stacklok/toolhive/issues/3178"},{"assignees":[],"author":{"id":"MDQ6VXNlcjcxNTUyMg==","is_bot":false,"login":"jhrozek","name":"Jakub Hrozek"},"body":"## Summary\n\nThe response filtering code silently ignores errors from authorization checks when filtering tools, prompts, and resources from list responses. This makes debugging authorization issues difficult and creates inconsistent behavior.\n\n## Current Behavior\n\nIn `pkg/authz/response_filter.go`, all three filter methods swallow errors:\n\n```go\n// filterToolsResponse (lines 271-274)\nif err != nil {\n    // If there's an error checking authorization, skip this tool\n    continue\n}\n\n// filterPromptsResponse (lines 323-326) - same pattern\n// filterResourcesResponse (lines 375-378) - same pattern\n```\n\n## Errors that get lost\n\n- `ErrMissingPrincipal` - identity/JWT claims not in context\n- `ErrMissingAction` / `ErrMissingResource` - empty action or resource\n- Entity parsing/creation failures\n- Cedar policy evaluation errors\n- Unsupported feature/operation combinations\n\n## Inconsistency\n\nNon-list operations properly return errors to clients:\n\n```go\n// middleware.go:177-189\nif err != nil || !authorized {\n    handleUnauthorized(w, parsedRequest.ID, err)\n    return\n}\n```\n\nBut list operations silently hide errors, making debugging hard.\n\n## Impact\n\n- Users see empty or partial lists with no indication something went wrong\n- Administrators have no visibility into filtering failures\n- Policy misconfigurations are invisible\n\n## Suggested Fix\n\nAt minimum, log the errors:\n\n```go\nif err != nil {\n    logger.Warnf(\"Authorization check failed for tool %q: %v\", tool.Name, err)\n    continue\n}\n```","closed":false,"closedAt":null,"closedByPullRequestsReferences":[],"comments":[],"createdAt":"2025-12-27T17:56:15Z","id":"I_kwDOOHdoXs7gaMBI","isPinned":false,"labels":[{"id":"LA_kwDOOHdoXs8AAAAB7bU0xQ","name":"bug","description":"Something isn't working","color":"d73a4a"},{"id":"LA_kwDOOHdoXs8AAAAB7bU02w","name":"good first issue","description":"Good for newcomers","color":"7057ff"},{"id":"LA_kwDOOHdoXs8AAAACB3O76w","name":"logging","description":"","color":"ededed"},{"id":"LA_kwDOOHdoXs8AAAACCmVMRg","name":"authentication","description":"","color":"ededed"}],"milestone":null,"number":3169,"reactionGroups":[],"state":"OPEN","stateReason":"","title":"Authorization errors silently swallowed during list response filtering","updatedAt":"2026-01-20T19:28:11Z","url":"https://github.com/stacklok/toolhive/issues/3169"},{"assignees":[{"id":"MDQ6VXNlcjI1MzA4NjE=","login":"yrobla","name":"Yolanda Robla Mota","databaseId":0}],"author":{"id":"MDQ6VXNlcjcxNTUyMg==","is_bot":false,"login":"jhrozek","name":"Jakub Hrozek"},"body":"## Summary\n\nWhile reviewing the authorization middleware, I noticed that unknown/unrecognized MCP methods bypass authorization checks entirely. Was this intentional, or should we switch to default-deny?\n\n## Current Behavior\n\nIn `pkg/authz/middleware.go:151-156`:\n\n```go\nfeatureOp, ok := MCPMethodToFeatureOperation[parsedRequest.Method]\nif !ok {\n    // Unknown method, let the next handler deal with it\n    next.ServeHTTP(w, r)\n    return\n}\n```\n\nWhen a method isn't in `MCPMethodToFeatureOperation`, the request proceeds without authorization.\n\n## Methods that bypass auth\n\nThe map only covers 11 methods, but the MCP parser (`pkg/mcp/parser.go`) handles many more:\n\n| Method | Authorization Status |\n|--------|---------------------|\n| `logging/setLevel` | Bypasses auth |\n| `sampling/createMessage` | Bypasses auth |\n| `completion/complete` | Bypasses auth |\n| `elicitation/create` | Bypasses auth |\n| `resources/subscribe` | Bypasses auth |\n| `resources/unsubscribe` | Bypasses auth |\n| `resources/templates/list` | Bypasses auth |\n| `roots/list` | Bypasses auth |\n| `tasks/*` (list, get, cancel, result) | Bypasses auth |\n| Any future MCP methods | Bypasses auth |\n\n## Questions\n\n1. Was there a reason for default-allow on unknown methods?\n2. Should we switch to default-deny for security?\n3. If some methods genuinely don't need auth, should we explicitly mark them as \"always allowed\" in the map?\n\n## Suggested Fix\n\nIf no strong reason exists for default-allow:\n\n```go\nif !ok {\n    handleUnauthorized(w, parsedRequest.ID, fmt.Errorf(\"unknown method: %s\", parsedRequest.Method))\n    return\n}\n```\n\nOr add all known methods to the map explicitly.","closed":false,"closedAt":null,"closedByPullRequestsReferences":[{"id":"PR_kwDOOHdoXs6-sgxe","number":3406,"repository":{"id":"R_kgDOOHdoXg","name":"toolhive","owner":{"id":"O_kgDOBpIYMg","login":"stacklok"}},"url":"https://github.com/stacklok/toolhive/pull/3406"}],"comments":[],"createdAt":"2025-12-27T17:56:09Z","id":"I_kwDOOHdoXs7gaL_9","isPinned":false,"labels":[{"id":"LA_kwDOOHdoXs8AAAAB7bU0xQ","name":"bug","description":"Something isn't working","color":"d73a4a"},{"id":"LA_kwDOOHdoXs8AAAAB828HLQ","name":"go","description":"Pull requests that update go code","color":"16e2e2"},{"id":"LA_kwDOOHdoXs8AAAACCmVMRg","name":"authentication","description":"","color":"ededed"},{"id":"LA_kwDOOHdoXs8AAAACN1ROLg","name":"critical","description":"","color":"ededed"}],"milestone":null,"number":3168,"reactionGroups":[],"state":"OPEN","stateReason":"","title":"Unknown MCP methods bypass authorization - intentional?","updatedAt":"2026-01-22T13:02:23Z","url":"https://github.com/stacklok/toolhive/issues/3168"},{"assignees":[],"author":{"id":"MDQ6VXNlcjM2NzEzMg==","is_bot":false,"login":"ghaskins","name":"Gregory Haskins"},"body":"## Problem Statement\n\nPull request #3110 adds support for pluggable authorizers.  One remaining gap is the presence of Cedar-isms in the CRDs.  For example:\n\nhttps://github.com/stacklok/toolhive/blob/c973cdc2a88dc7b2c0c3e33f65bb1eade39345e5/deploy/charts/operator-crds/files/crds/toolhive.stacklok.dev_mcpservers.yaml#L93\n\nThere are a few ways to handle this, but they all likely require a new version of the affected CRDs:\n\n## Possible Solutions\n\n1.  New CRD schema drops \"inline\" authz support, relying purely on a configmap-reference.  Validation would remain at the code level but would be removed from the schema level.\n2.  New CRD schema modifies \"inline\" authz support to relax schema checking (see https://kubernetes.io/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definitions/#controlling-pruning) to accommodate various types of authz plugins.  Validation would remain at the code level, but is removed at the schema level\n3.  We drop \"configmap-reference\" support and create CRD(s) for Authz configuration.  The inline configuration would be generalized to accept an inline representation of the Authz configuration using [RawExtensions](https://kubernetes.io/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definitions/#rawextension). Likewise, the previous use cases for configmap-based Authz configuration would now use the new Authz CRD.  Validation would remain at the code and inline schema levels, and is now also introduced at the \"external reference\" level, since we've replaced ConfigMaps with a CRD. ","closed":false,"closedAt":null,"closedByPullRequestsReferences":[],"comments":[{"id":"IC_kwDOOHdoXs7b63td","author":{"login":"ghaskins"},"authorAssociation":"CONTRIBUTOR","body":"| Option | Inline Validation | External Reference Validation | Plugin Support |\n|--------|-----------------|------------------------------|----------------|\n| Current CRDs | Yes | No | No |\n| Proposal 1 | n/a | No | Yes |\n| Proposal 2 | No | No | Yes |\n| Proposal 3 (*) | Yes | Yes | Yes |\n\n(*): While Proposal 3 looks appealing feature-wise, it should be pointed out that it is also redundant with the concept of a ConfigMap and goes against the grain a bit, so this fact should be considered as well. ","createdAt":"2025-12-24T12:14:42Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/stacklok/toolhive/issues/3157#issuecomment-3689642845","viewerDidAuthor":false}],"createdAt":"2025-12-24T12:03:20Z","id":"I_kwDOOHdoXs7gH2gP","isPinned":false,"labels":[{"id":"LA_kwDOOHdoXs8AAAAB7bU01g","name":"enhancement","description":"New feature or request","color":"a2eeef"},{"id":"LA_kwDOOHdoXs8AAAAB9PXLvA","name":"kubernetes","description":"Items related to Kubernetes","color":"0000FF"},{"id":"LA_kwDOOHdoXs8AAAACCmVMRg","name":"authentication","description":"","color":"ededed"},{"id":"LA_kwDOOHdoXs8AAAACNqqAVQ","name":"operator","description":"","color":"ededed"}],"milestone":null,"number":3157,"reactionGroups":[],"state":"OPEN","stateReason":"","title":"CRDs need updates to accommodate authorizer-plugin support","updatedAt":"2025-12-24T12:14:42Z","url":"https://github.com/stacklok/toolhive/issues/3157"},{"assignees":[{"id":"MDQ6VXNlcjI1MzA4NjE=","login":"yrobla","name":"Yolanda Robla Mota","databaseId":0}],"author":{"id":"MDQ6VXNlcjY2ODk3OTc1","is_bot":false,"login":"4t8dd","name":"4t8dd"},"body":"\nImplement K8SReporter to update VirtualMCPServer.Status from the vMCP runtime.\n\nFour step to implement:\n1. K8SReporter Implementation\n2. RBAC Permissions. Update vMCP runtime service account to edit VMCP CRD status.\n3. Server Integration:\n    1. update server config\n    2. start/stop along with server.\n4. update runtime main to initialize:\n      Flow:\n        1 . Check VMCP_NAME and VMCP_NAMESPACE env vars (set by operator in deployment)\n        2. If present → Kubernetes mode → create K8SReporter\n        3. If absent → CLI mode → create NoOpReporter\n        4. Pass reporter to Server config\n        5. Server lifecycle manages reporter (Start/Stop)\n\n4. Test coverage\n   we need Unit Test and a new e2e test case for this.\n  \n\nRefer to #2854 for more details  and depends #3148 #3147 ","closed":false,"closedAt":null,"closedByPullRequestsReferences":[],"comments":[],"createdAt":"2025-12-23T14:30:07Z","id":"I_kwDOOHdoXs7f9_Rd","isPinned":false,"labels":[{"id":"LA_kwDOOHdoXs8AAAAB7bU01g","name":"enhancement","description":"New feature or request","color":"a2eeef"},{"id":"LA_kwDOOHdoXs8AAAAB828HLQ","name":"go","description":"Pull requests that update go code","color":"16e2e2"},{"id":"LA_kwDOOHdoXs8AAAAB9PXLvA","name":"kubernetes","description":"Items related to Kubernetes","color":"0000FF"},{"id":"LA_kwDOOHdoXs8AAAACJiu1Bw","name":"api","description":"Items related to the API","color":"b404c2"},{"id":"LA_kwDOOHdoXs8AAAACNqqAVQ","name":"operator","description":"","color":"ededed"},{"id":"LA_kwDOOHdoXs8AAAACQ-UOJw","name":"vmcp","description":"Virtual MCP Server related issues","color":"5319E7"}],"milestone":null,"number":3149,"reactionGroups":[],"state":"OPEN","stateReason":"","title":"Implement K8SReporter for Kubernetes status updates","updatedAt":"2026-01-12T09:19:44Z","url":"https://github.com/stacklok/toolhive/issues/3149"},{"assignees":[{"id":"MDQ6VXNlcjI1MzA4NjE=","login":"yrobla","name":"Yolanda Robla Mota","databaseId":0}],"author":{"id":"MDQ6VXNlcjY2ODk3OTc1","is_bot":false,"login":"4t8dd","name":"4t8dd"},"body":"  ## Summary\n\n  Implement the core StatusReporter abstraction to enable vMCP runtime to report operational status. This is the foundation for eliminating duplicate backend discovery work between the operator and vMCP runtime.\n\n  This issue implements the **interface and CLI-mode implementation only** (no Kubernetes integration). The K8s implementation will follow in a separate PR to keep changes focused and reviewable.\n\n  ## Motivation\n\n  Currently, the operator must infer vMCP runtime status through polling and discovery. This creates:\n  - Duplicate backend discovery work (operator discovers, then vMCP discovers again)\n  - Delayed status updates (operator polls periodically)\n  - No visibility into vMCP runtime health\n\n  By adding StatusReporter, the vMCP runtime can push status updates directly to the control plane.\n\n  ## Scope of This PR\n\n  ### What's Included ✅\n  - Platform-agnostic `Reporter` interface\n  - Status model (Phase, Conditions, DiscoveredBackends)\n  - `NoOpReporter` for CLI mode\n  - Tests for NoOpReporter\n  - Basic documentation\n\n  Dependencies\n\n  None - this is a pure code addition with zero external dependencies.\n\n  Acceptance Criteria\n\n  - Reporter interface defined\n  - Status model complete with all types\n  - NoOpReporter implemented\n  - README documents the abstraction\n  - No Kubernetes dependencies in this PR\n  - Linter passes\n\nrelated to #2854 ","closed":false,"closedAt":null,"closedByPullRequestsReferences":[],"comments":[{"id":"IC_kwDOOHdoXs7fu5zn","author":{"login":"4t8dd"},"authorAssociation":"CONTRIBUTOR","body":"@yrobla ah, you implement again? I already got a PR for this in Dec, waiting for review.","createdAt":"2026-01-15T08:53:12Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/stacklok/toolhive/issues/3147#issuecomment-3753614567","viewerDidAuthor":false},{"id":"IC_kwDOOHdoXs7fvJ86","author":{"login":"jhrozek"},"authorAssociation":"MEMBER","body":"@4t8dd I apologize, we had a large backlog of PRs during the holiday break and we're still catching up. Yours and Yolanda's are on my list, I'll see about merging them today/tomorrow.\n\nSorry about that, it was not that we ignore community contributions, it's an oversight because of the large number of PRs/issues we've been handling in the past couple of weeks.","createdAt":"2026-01-15T09:10:18Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/stacklok/toolhive/issues/3147#issuecomment-3753680698","viewerDidAuthor":false},{"id":"IC_kwDOOHdoXs7f-Jk9","author":{"login":"4t8dd"},"authorAssociation":"CONTRIBUTOR","body":"@jhrozek OK. I got you. \n\nwhat I can not understand is why people implements again even with my PR provided? Is this a competition? Are you goging to review both of them to pick better one to accept?\n\nI created that PR before the Chriastmas, And no one can review it.  Now @yrobla  just came out to implement them again without any comments on my PR. why? what is your strategy to communicate with contributors? Let me know this. Thanks.\n","createdAt":"2026-01-16T01:12:25Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/stacklok/toolhive/issues/3147#issuecomment-3757611325","viewerDidAuthor":false},{"id":"IC_kwDOOHdoXs7gCpGb","author":{"login":"jhrozek"},"authorAssociation":"MEMBER","body":"> [@jhrozek](https://github.com/jhrozek) OK. I got you.\n> \n> what I can not understand is why people implements again even with my PR provided? Is this a competition? Are you goging to review both of them to pick better one to accept?\n> \n> I created that PR before the Chriastmas, And no one can review it. Now [@yrobla](https://github.com/yrobla) just came out to implement them again without any comments on my PR. why? what is your strategy to communicate with contributors? Let me know this. Thanks.\n\nThere's no competition or such. I'm sorry if it ended up looking like this. It's really just an honest mistake where we didn't manage our issue assignments and PR backlog well. The Christmas break where everyone forgot what's being worked on didn't make this better.\n\nI'm sorry, this is on us and we need to get better at PR and issue management.","createdAt":"2026-01-16T08:41:29Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/stacklok/toolhive/issues/3147#issuecomment-3758789019","viewerDidAuthor":false},{"id":"IC_kwDOOHdoXs7gCuPE","author":{"login":"yrobla"},"authorAssociation":"MEMBER","body":"Sorry for the late delay in answer but i am on Pto this week. There was no competition or bad intention at all. Simply this issue was on the scope of my assigned tasks and i implemented It.\nThere was a huge backlog of prs to review and i didn't see that this was already implemented.\nWhat usually helps with that as well is to assign the issue you are working on to yourself, or add some comment mentioning It, It makes your collaboration more visible and prevents overlaps like that.\nApologies, and i am happy to close mine if yours is covering our needs.","createdAt":"2026-01-16T08:48:01Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/stacklok/toolhive/issues/3147#issuecomment-3758810052","viewerDidAuthor":false},{"id":"IC_kwDOOHdoXs7gJ8qC","author":{"login":"4t8dd"},"authorAssociation":"CONTRIBUTOR","body":"@yrobla \nOh, I didn't know I can assign the issue to myself, can I do that? I even didn't try that because I never anyone do this.\nyou are right. I should assign this to myself. \n\nThis issue is one of the splitted when I work on the original which is too big. So splitted this so that each one can be a reasonable size and easy to review. And this is the base one for other issues.\n\nOK. I would focus on the resources series PR which should composed of multiple ones. I just completed the first stage.\nI will focus that one, leaving this to you. ","createdAt":"2026-01-16T15:51:52Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/stacklok/toolhive/issues/3147#issuecomment-3760704130","viewerDidAuthor":false}],"createdAt":"2025-12-23T13:17:36Z","id":"I_kwDOOHdoXs7f9LFX","isPinned":false,"labels":[{"id":"LA_kwDOOHdoXs8AAAAB7bU01g","name":"enhancement","description":"New feature or request","color":"a2eeef"},{"id":"LA_kwDOOHdoXs8AAAAB828HLQ","name":"go","description":"Pull requests that update go code","color":"16e2e2"},{"id":"LA_kwDOOHdoXs8AAAACJiu1Bw","name":"api","description":"Items related to the API","color":"b404c2"},{"id":"LA_kwDOOHdoXs8AAAACQ-UOJw","name":"vmcp","description":"Virtual MCP Server related issues","color":"5319E7"}],"milestone":null,"number":3147,"reactionGroups":[],"state":"OPEN","stateReason":"","title":"Add StatusReporter abstraction for vMCP runtime (foundation)","updatedAt":"2026-01-16T15:51:53Z","url":"https://github.com/stacklok/toolhive/issues/3147"},{"assignees":[{"id":"MDQ6VXNlcjcxNTUyMg==","login":"jhrozek","name":"Jakub Hrozek","databaseId":0}],"author":{"id":"MDQ6VXNlcjY5MjI1MTU=","is_bot":false,"login":"danbarr","name":"Dan Barr"},"body":"## Problem\n\nMultiple OIDC configuration fields in MCPServer and VirtualMCPServer CRDs are defined but never actually used, preventing secure OIDC authentication in several scenarios:\n\n1. **`thvCABundlePath`**: Not applied to token validator, preventing connections to OIDC providers with self-signed or internal CA certificates\n2. **`protectedResourceAllowPrivateIP`**: Not propagated through resolver, and incorrectly mapped from wrong source field\n\n## Impact\n\n### Impact of `thvCABundlePath` Bug\n\nWhen using MCPServer or VirtualMCPServer with OIDC authentication against a provider with a non-publicly-trusted certificate (e.g., Keycloak with cert-manager internal cluster issuer), TLS verification fails even when:\n- The CA certificate is mounted into the pod\n- The `thvCABundlePath` is correctly configured in the CRD\n\nThis affects:\n- JWKS fetching\n- OIDC discovery\n- Token introspection\n\nAll OIDC HTTP connections will fail with TLS verification errors.\n\n### Impact of `protectedResourceAllowPrivateIP` Bug\n\nThe `protectedResourceAllowPrivateIP` field has multiple issues:\n1. Setting `protectedResourceAllowPrivateIP: true` in the CRD has **NO EFFECT** (field is never read from CRD)\n2. Setting `jwksAllowPrivateIP: true` **INCORRECTLY** enables private IPs for the protected resource endpoint (wrong field mapping)\n3. There is **NO WAY** to independently control JWKS private IP allowance vs protected resource private IP allowance\n\nThis prevents proper security configuration when JWKS and protected resource endpoints have different network accessibility requirements.\n\n## Affected Resources\n\n**Both MCPServer and VirtualMCPServer are affected** because they:\n- Share identical `InlineOIDCConfig` structure definitions\n- Use the same OIDC resolver code path (`cmd/thv-operator/pkg/oidc/resolver.go`)\n- Call the same `runner.WithOIDCConfig()` function where the bugs exist\n\n## Root Causes\n\n### Bug 1: `thvCABundlePath` Not Applied to TokenValidatorConfig\n\n**Location:** `pkg/runner/config_builder.go` lines 331-341\n\nWhen creating the `TokenValidatorConfig`, the `CACertPath` and `AuthTokenFile` fields are not populated:\n\n```go\nb.config.OIDCConfig = &auth.TokenValidatorConfig{\n    Issuer:            oidcIssuer,\n    Audience:          oidcAudience,\n    JWKSURL:           oidcJwksURL,\n    IntrospectionURL:  oidcIntrospectionURL,\n    ClientID:          oidcClientID,\n    ClientSecret:      oidcClientSecret,\n    AllowPrivateIP:    jwksAllowPrivateIP,\n    InsecureAllowHTTP: insecureAllowHTTP,\n    Scopes:            scopes,\n    // MISSING: CACertPath and AuthTokenFile are not set here!\n}\n```\n\nThe values are stored on `RunConfig.ThvCABundle` (line 345) and `RunConfig.JWKSAuthTokenFile` (line 346) but never passed to the `OIDCConfig` structure that's actually used by the token validator.\n\n### Bug 2: `protectedResourceAllowPrivateIP` Missing from Resolver\n\n**Location 1:** `cmd/thv-operator/pkg/oidc/resolver.go` lines 27-40\n\nThe `OIDCConfig` struct is missing the `ProtectedResourceAllowPrivateIP` field:\n\n```go\ntype OIDCConfig struct {\n    Issuer             string\n    Audience           string\n    JWKSURL            string\n    IntrospectionURL   string\n    ClientID           string\n    ClientSecret       string\n    ThvCABundlePath    string\n    JWKSAuthTokenPath  string\n    ResourceURL        string\n    JWKSAllowPrivateIP bool\n    InsecureAllowHTTP  bool\n    Scopes             []string\n    // MISSING: ProtectedResourceAllowPrivateIP bool\n}\n```\n\n**Location 2:** `cmd/thv-operator/pkg/oidc/resolver.go` line 234\n\nThe `resolveInlineConfig()` function doesn't copy the field:\n\n```go\nreturn &OIDCConfig{\n    Issuer:             config.Issuer,\n    Audience:           config.Audience,\n    JWKSURL:            config.JWKSURL,\n    IntrospectionURL:   config.IntrospectionURL,\n    ClientID:           config.ClientID,\n    ClientSecret:       clientSecret,\n    ThvCABundlePath:    config.ThvCABundlePath,\n    JWKSAuthTokenPath:  config.JWKSAuthTokenPath,\n    ResourceURL:        resourceURL,\n    JWKSAllowPrivateIP: config.JWKSAllowPrivateIP,\n    InsecureAllowHTTP:  config.InsecureAllowHTTP,\n    Scopes:             config.Scopes,\n    // MISSING: ProtectedResourceAllowPrivateIP: config.ProtectedResourceAllowPrivateIP,\n}, nil\n```\n\n### Bug 3: Wrong Field Mapped in Converter\n\n**Location:** `cmd/thv-operator/pkg/vmcpconfig/converter.go` line 206\n\nThe converter maps the wrong source field:\n\n```go\nconfig := &vmcpconfig.OIDCConfig{\n    Issuer:                          resolved.Issuer,\n    ClientID:                        resolved.ClientID,\n    Audience:                        resolved.Audience,\n    Resource:                        resolved.ResourceURL,\n    ProtectedResourceAllowPrivateIP: resolved.JWKSAllowPrivateIP,  // BUG: Wrong source!\n    InsecureAllowHTTP:               resolved.InsecureAllowHTTP,\n    Scopes:                          resolved.Scopes,\n}\n```\n\nThis should use `resolved.ProtectedResourceAllowPrivateIP` (once that field exists).\n\n## Evidence from Tests\n\n### Evidence for `thvCABundlePath` Bug\n\nThe test files explicitly acknowledge this bug with comments:\n\n**File:** `cmd/thv-operator/controllers/mcpserver_runconfig_test.go` lines 407-408, 810-811:\n\n```go\n// NOTE: CACertPath and AuthTokenFile are not currently mapped in WithOIDCConfig function\n// This is likely a bug that should be fixed separately\nassert.Equal(t, \"\", runConfig.OIDCConfig.CACertPath)\nassert.Equal(t, \"\", runConfig.OIDCConfig.AuthTokenFile)\n```\n\n### Evidence for `protectedResourceAllowPrivateIP` Bug\n\n**File:** `cmd/thv-operator/pkg/vmcpconfig/converter_test.go` lines 83-94:\n\nThe test expects `ProtectedResourceAllowPrivateIP` to be set when `JWKSAllowPrivateIP` is true (testing the incorrect behavior):\n\n```go\nmockReturn: &oidc.OIDCConfig{\n    Issuer: \"https://issuer.example.com\", Audience: \"my-audience\",\n    ResourceURL: \"https://resource.example.com\", JWKSAllowPrivateIP: true,\n},\nvalidate: func(t *testing.T, config *vmcpconfig.Config, err error) {\n    require.NoError(t, err)\n    assert.True(t, config.IncomingAuth.OIDC.ProtectedResourceAllowPrivateIP)  // Wrong!\n},\n```\n\n## Configuration Flow\n\nThe fields ARE correctly defined and partially propagated:\n\n### For `thvCABundlePath`:\n1. ✅ CRD Definition: `cmd/thv-operator/api/v1alpha1/mcpserver_types.go:495`\n2. ✅ OIDC Resolver: `cmd/thv-operator/pkg/oidc/resolver.go:187,228`\n3. ✅ Config Builder: `cmd/thv-operator/pkg/controllerutil/oidc.go:42`\n4. ✅ RunConfig Storage: `pkg/runner/config_builder.go:345-346`\n5. ❌ **TokenValidatorConfig: NOT mapped** (this is the bug)\n\n### For `protectedResourceAllowPrivateIP`:\n1. ✅ CRD Definition: `cmd/thv-operator/api/v1alpha1/mcpserver_types.go:508-512`\n2. ❌ **Resolver struct: Field missing** (bug)\n3. ❌ **Resolver copy: Field not copied** (bug)\n4. ❌ **Converter: Wrong field mapped** (bug)\n5. ✅ Used correctly in: `pkg/vmcp/auth/factory/incoming.go:76-84` (but never receives correct value)\n\n## Proposed Fixes\n\n### Fix 1: Map `thvCABundlePath` to TokenValidatorConfig\n\nUpdate `pkg/runner/config_builder.go` lines 331-341:\n\n```go\nb.config.OIDCConfig = &auth.TokenValidatorConfig{\n    Issuer:            oidcIssuer,\n    Audience:          oidcAudience,\n    JWKSURL:           oidcJwksURL,\n    IntrospectionURL:  oidcIntrospectionURL,\n    ClientID:          oidcClientID,\n    ClientSecret:      oidcClientSecret,\n    CACertPath:        thvCABundle,        // ADD THIS\n    AuthTokenFile:     jwksAuthTokenFile,  // ADD THIS\n    AllowPrivateIP:    jwksAllowPrivateIP,\n    InsecureAllowHTTP: insecureAllowHTTP,\n    Scopes:            scopes,\n}\n```\n\n### Fix 2: Add `protectedResourceAllowPrivateIP` to Resolver\n\nUpdate `cmd/thv-operator/pkg/oidc/resolver.go` line 40:\n\n```go\ntype OIDCConfig struct {\n    Issuer                          string\n    Audience                        string\n    JWKSURL                         string\n    IntrospectionURL                string\n    ClientID                        string\n    ClientSecret                    string\n    ThvCABundlePath                 string\n    JWKSAuthTokenPath               string\n    ResourceURL                     string\n    JWKSAllowPrivateIP              bool\n    ProtectedResourceAllowPrivateIP bool  // ADD THIS\n    InsecureAllowHTTP               bool\n    Scopes                          []string\n}\n```\n\n### Fix 3: Copy Field in resolveInlineConfig\n\nUpdate `cmd/thv-operator/pkg/oidc/resolver.go` line 234:\n\n```go\nreturn &OIDCConfig{\n    // ... existing fields ...\n    ProtectedResourceAllowPrivateIP: config.ProtectedResourceAllowPrivateIP,  // ADD THIS\n}, nil\n```\n\nAlso update `resolveConfigMapConfig()` around line 187 similarly.\n\n### Fix 4: Fix Converter Mapping\n\nUpdate `cmd/thv-operator/pkg/vmcpconfig/converter.go` line 206:\n\n```go\nconfig := &vmcpconfig.OIDCConfig{\n    Issuer:                          resolved.Issuer,\n    ClientID:                        resolved.ClientID,\n    Audience:                        resolved.Audience,\n    Resource:                        resolved.ResourceURL,\n    ProtectedResourceAllowPrivateIP: resolved.ProtectedResourceAllowPrivateIP,  // FIX THIS\n    InsecureAllowHTTP:               resolved.InsecureAllowHTTP,\n    Scopes:                          resolved.Scopes,\n}\n```\n\n## Test Updates Required\n\n### Update MCPServer/VirtualMCPServer RunConfig Tests\n\nIn `cmd/thv-operator/controllers/mcpserver_runconfig_test.go`:\n\n```go\n// Remove the bug acknowledgment comments and assert proper values:\nassert.Equal(t, \"/etc/ssl/ca-bundle.pem\", runConfig.OIDCConfig.CACertPath)\nassert.Equal(t, \"/path/to/token\", runConfig.OIDCConfig.AuthTokenFile)\n```\n\n### Update Converter Test\n\nIn `cmd/thv-operator/pkg/vmcpconfig/converter_test.go`, fix the test to use the correct field:\n\n```go\nmockReturn: &oidc.OIDCConfig{\n    Issuer: \"https://issuer.example.com\",\n    Audience: \"my-audience\",\n    ResourceURL: \"https://resource.example.com\",\n    ProtectedResourceAllowPrivateIP: true,  // FIX: Use correct field\n},\n```\n\n## Workarounds\n\n### For `thvCABundlePath`\nCurrently, there is no good workaround except:\n- Using `insecureAllowHTTP: true` (not recommended for production)\n- Using a publicly-trusted certificate for your OIDC provider\n\n### For `protectedResourceAllowPrivateIP`\nCurrently, setting `jwksAllowPrivateIP: true` will incorrectly also allow private IPs for the protected resource endpoint. There is no way to control these independently.\n\n## Environment\n\n- Components: MCPServer, VirtualMCPServer, vmcp\n- Affected versions: All versions with OIDC support\n- Related files:\n  - `pkg/runner/config_builder.go`\n  - `pkg/auth/token.go`\n  - `cmd/thv-operator/api/v1alpha1/mcpserver_types.go`\n  - `cmd/thv-operator/pkg/oidc/resolver.go`\n  - `cmd/thv-operator/pkg/vmcpconfig/converter.go`","closed":false,"closedAt":null,"closedByPullRequestsReferences":[],"comments":[],"createdAt":"2025-12-23T00:39:15Z","id":"I_kwDOOHdoXs7f2op_","isPinned":false,"labels":[{"id":"LA_kwDOOHdoXs8AAAAB7bU0xQ","name":"bug","description":"Something isn't working","color":"d73a4a"},{"id":"LA_kwDOOHdoXs8AAAACCmVMRg","name":"authentication","description":"","color":"ededed"},{"id":"LA_kwDOOHdoXs8AAAACNqqAVQ","name":"operator","description":"","color":"ededed"},{"id":"LA_kwDOOHdoXs8AAAACQ-UOJw","name":"vmcp","description":"Virtual MCP Server related issues","color":"5319E7"},{"id":"LA_kwDOOHdoXs8AAAACTJXnTQ","name":"security","description":"","color":"ededed"}],"milestone":null,"number":3142,"reactionGroups":[],"state":"OPEN","stateReason":"","title":"OIDC configuration fields not properly applied (thvCABundlePath, protectedResourceAllowPrivateIP)","updatedAt":"2026-01-15T23:20:06Z","url":"https://github.com/stacklok/toolhive/issues/3142"}]
