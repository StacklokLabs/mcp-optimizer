apiVersion: toolhive.stacklok.dev/v1alpha1
kind: MCPServer
metadata:
  name: {{ .Values.mcpserver.name }}
  namespace: {{ .Values.mcpserver.namespace }}
  labels:
    {{- include "mcp-optimizer.labels" . | nindent 4 }}
    {{- with .Values.mcpserver.labels }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
  {{- with .Values.mcpserver.annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
spec:
  # Container image
  image: {{ include "mcp-optimizer.image" . }}
  
  # Transport protocol (mcp-optimizer only supports streamable-http)
  transport: {{ .Values.mcpserver.transport }}
  
  # Proxy mode (hard-coded to streamable-http as mcp-optimizer doesn't support stdio)
  proxyMode: streamable-http
  
  # Port configuration
  port: {{ .Values.mcpserver.port }}
  {{- if .Values.mcpserver.targetPort }}
  targetPort: {{ .Values.mcpserver.targetPort }}
  {{- end }}
  
  # Service account for Kubernetes API access
  serviceAccount: {{ include "mcp-optimizer.serviceAccountName" . }}

  # Pod template spec with merged environment variables
  {{- if .Values.mcpserver.podTemplateSpec }}
  podTemplateSpec:
    {{- include "mcp-optimizer.podTemplateSpec" . | nindent 4 }}
  {{- end }}

